<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國民健康儀表板 - FHIR CQL Platform</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/llm-connection.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-heartbeat"></i>
                <span>FHIR CQL Platform</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">首頁</a></li>
                <li><a href="disease-control.html">傳染病管制</a></li>
                <li><a href="public-health.html" class="active">國民健康</a></li>
                <li><a href="esg-indicators.html">ESG指標</a></li>
                <li><a href="quality-indicators.html">醫療品質</a></li>
            </ul>
            <div class="nav-settings" onclick="openLLMSettingsModal()" style="cursor: pointer;" title="LLM設定">
                <i class="fas fa-cog"></i>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <main class="main-content">
        <!-- 頁面標題 -->
        <section class="page-header">
            <div class="header-content">
                <h1><i class="fas fa-heart-pulse"></i> 國民健康儀表板</h1>
                <p>疫苗接種與慢性病管理監測系統</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="toggleDemoMode()" id="demoModeBtn" style="margin-right: 10px;">
                    <i class="fas fa-flask"></i> <span id="demoModeText">啟用示範模式</span>
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> 重新整理
                </button>
            </div>
        </section>

        <!-- FHIR 連線狀態 -->
        <section class="connection-banner" id="connectionBanner">
            <div class="banner-content">
                <i class="fas fa-exclamation-triangle"></i>
                <span>請先在首頁設定 FHIR 伺服器連線</span>
                <a href="index.html" class="btn btn-sm">前往設定</a>
            </div>
        </section>

        <!-- 健康指標總覽 -->
        <section class="overview-section">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> 健康指標總覽</h2>
                <p>疫苗接種率與慢性病管理成效</p>
            </div>
            
            <div class="overview-grid">
                <!-- COVID-19疫苗接種率 -->
                <div class="overview-card health-vaccine" onclick="showDetailModal('covid19-vaccine')">
                    <div class="card-icon">
                        <i class="fas fa-syringe"></i>
                    </div>
                    <div class="card-content">
                        <h3>COVID-19 疫苗接種率 <span class="cql-badge-mini">COVID19VaccinationCoverage</span></h3>
                        <div class="card-description">
                            <p>監測 COVID-19 疫苗接種涵蓋率與劑次完成度</p>
                            <ul class="card-features">
                                <li>✓ 第一劑接種率</li>
                                <li>✓ 完整接種率</li>
                                <li>✓ 追加劑接種率</li>
                            </ul>
                        </div>
                        <div class="card-stats">
                            <div class="stat-row">
                                <div class="stat-item-inline">
                                    <span class="stat-label">接種人數</span>
                                    <span class="stat-value" id="covidVaccineCount">--</span>
                                </div>
                                <div class="stat-item-inline">
                                    <span class="stat-label">接種率</span>
                                    <span class="stat-value" id="covidVaccineRate">--%</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn-card-execute" onclick="event.stopPropagation(); executeQuery('covid19-vaccine')" id="btnCovidVaccine">
                                <i class="fas fa-play"></i> 執行查詢
                            </button>
                        </div>
                        <div class="card-status" id="statusCovidVaccine"></div>
                    </div>
                    <div class="card-hover-hint">
                        <i class="fas fa-expand"></i> 點擊查看詳情
                    </div>
                </div>

                <!-- 流感疫苗接種率 -->
                <div class="overview-card health-vaccine" onclick="showDetailModal('influenza-vaccine')">
                    <div class="card-icon">
                        <i class="fas fa-shield-virus"></i>
                    </div>
                    <div class="card-content">
                        <h3>流感疫苗接種率 <span class="cql-badge-mini">InfluenzaVaccinationCoverage</span></h3>
                        <div class="card-description">
                            <p>追蹤季節性流感疫苗接種涵蓋率</p>
                            <ul class="card-features">
                                <li>✓ 65歲以上長者</li>
                                <li>✓ 高風險族群</li>
                                <li>✓ 醫護人員</li>
                            </ul>
                        </div>
                        <div class="card-stats">
                            <div class="stat-row">
                                <div class="stat-item-inline">
                                    <span class="stat-label">接種人數</span>
                                    <span class="stat-value" id="fluVaccineCount">--</span>
                                </div>
                                <div class="stat-item-inline">
                                    <span class="stat-label">接種率</span>
                                    <span class="stat-value" id="fluVaccineRate">--%</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn-card-execute" onclick="event.stopPropagation(); executeQuery('influenza-vaccine')" id="btnFluVaccine">
                                <i class="fas fa-play"></i> 執行查詢
                            </button>
                        </div>
                        <div class="card-status" id="statusFluVaccine"></div>
                    </div>
                    <div class="card-hover-hint">
                        <i class="fas fa-expand"></i> 點擊查看詳情
                    </div>
                </div>

                <!-- 高血壓管理 -->
                <div class="overview-card health-chronic" onclick="showDetailModal('hypertension')">
                    <div class="card-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="card-content">
                        <h3>高血壓活動個案數 <span class="cql-badge-mini">HypertensionActiveCases</span></h3>
                        <div class="card-description">
                            <p>監測高血壓患者的管理與控制情況</p>
                            <ul class="card-features">
                                <li>✓ 活動個案數</li>
                                <li>✓ 血壓控制率</li>
                                <li>✓ 用藥遵從性</li>
                            </ul>
                        </div>
                        <div class="card-stats">
                            <div class="stat-row">
                                <div class="stat-item-inline">
                                    <span class="stat-label">活動個案</span>
                                    <span class="stat-value" id="hypertensionCount">--</span>
                                </div>
                                <div class="stat-item-inline">
                                    <span class="stat-label">控制率</span>
                                    <span class="stat-value" id="hypertensionRate">--%</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn-card-execute" onclick="event.stopPropagation(); executeQuery('hypertension')" id="btnHypertension">
                                <i class="fas fa-play"></i> 執行查詢
                            </button>
                        </div>
                        <div class="card-status" id="statusHypertension"></div>
                        <div class="card-disclaimer" style="font-size: 0.75rem; color: #94a3b8; margin-top: 8px; padding: 0 12px; line-height: 1.4;">
                            <i class="fas fa-info-circle" style="font-size: 0.7rem;"></i> 數據和計算都是正確的，數字反映的是測試伺服器數據質量問題，而非真實的醫療控制率。
                        </div>
                    </div>
                    <div class="card-hover-hint">
                        <i class="fas fa-expand"></i> 點擊查看詳情
                    </div>
                </div>
            </div>
        </section>

        <!-- 詳細統計區 -->
        <section class="details-section" style="display: none;" id="detailsSection">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> 詳細數據分析</h2>
                <button class="btn btn-secondary" onclick="closeDetails()">
                    <i class="fas fa-times"></i> 關閉
                </button>
            </div>
            <div class="details-content" id="detailsContent">
                <!-- 動態載入詳細資訊 -->
            </div>
        </section>
    </main>

    <!-- 詳情 Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="modalTitle">詳細資訊</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 動態載入內容 -->
            </div>
        </div>
    </div>

    <!-- LLM 設定模態框 -->
    <div id="llmSettingsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
                <h3><i class="fas fa-brain"></i> LLM 連線控制台 - 國民健康儀表板</h3>
                <span class="modal-close" onclick="closeLLMSettingsModal()" style="color: white;">&times;</span>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <!-- LLM 服務控制 -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: #1e293b;">
                            <i class="fas fa-power-off"></i> 服務控制
                        </h4>
                        <div style="display: flex; gap: 0.75rem;">
                            <button id="uiConnectBtn" onclick="toggleUIConnection()" class="btn-external-service inactive">
                                <i class="fas fa-window-restore"></i> <span>連線 UI/UX</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 四節點連接狀態圖 -->
                    <div class="llm-connection-flow">
                        <div class="connection-flow-header">
                            <h5>連接狀態</h5>
                        </div>
                        
                        <div class="connection-nodes-container">
                            <!-- FHIR 伺服器 -->
                            <div class="connection-node node-fhir">
                                <div class="node-circle">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">FHIR</div>
                                    <div class="node-subtitle">伺服器</div>
                                </div>
                            </div>
                            
                            <!-- 連接線 1: FHIR → 控制網頁 -->
                            <div class="connection-line-wrapper">
                                <div class="connection-line line-fhir-control connected"></div>
                            </div>
                            
                            <!-- 控制網頁 -->
                            <div class="connection-node node-control">
                                <div class="node-circle">
                                    <i class="fas fa-desktop"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">控制網頁</div>
                                    <div class="node-subtitle">醫護人員</div>
                                </div>
                            </div>
                            
                            <!-- 連接線 2: 控制網頁 → 民眾網頁 -->
                            <div class="connection-line-wrapper">
                                <div class="connection-line line-control-public disconnected"></div>
                            </div>
                            
                            <!-- 民眾網頁 -->
                            <div class="connection-node node-public">
                                <div class="node-circle">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">民眾網頁</div>
                                    <div class="node-subtitle">公開版</div>
                                </div>
                            </div>
                            
                            <!-- 連接線 3: 民眾網頁 → LLM -->
                            <div class="connection-line-wrapper">
                                <div class="connection-line line-public-llm disconnected"></div>
                            </div>
                            
                            <!-- LLM 智能模型 -->
                            <div class="connection-node node-llm">
                                <div class="node-circle">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">LLM</div>
                                    <div class="node-subtitle">智能模型</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="connection-flow-status">
                            <i class="fas fa-info-circle"></i>
                            <span id="llmConnectionMessage">預設狀態: FHIR ↔ 控制網頁 | 民眾網頁 ↔ LLM (計費中)</span>
                        </div>
                    </div>
                </div>
                
                <!-- 使用狀態 -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 1rem 0; color: #1e293b;">
                        <i class="fas fa-chart-line"></i> 即時使用狀態
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 0.75rem; color: #1e40af; margin-bottom: 0.3rem;">查詢次數</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af;" id="queryCount">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-size: 0.75rem; color: #065f46; margin-bottom: 0.3rem;">輸入 Token</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #065f46;" id="inputTokens">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 0.75rem; color: #92400e; margin-bottom: 0.3rem;">輸出 Token</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #92400e;" id="outputTokens">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); padding: 1rem; border-radius: 8px; border-left: 4px solid #ec4899;">
                            <div style="font-size: 0.75rem; color: #831843; margin-bottom: 0.3rem;">資料傳輸</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #831843;" id="dataTransfer">0 KB</div>
                        </div>
                    </div>
                </div>
                
                <!-- 獲利金額 -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 1rem 0; color: #1e293b;">
                        <i class="fas fa-dollar-sign"></i> 獲利金額 (USD)
                    </h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 0.75rem; text-align: left; color: #64748b; font-weight: 600;">項目</th>
                                <th style="padding: 0.75rem; text-align: right; color: #64748b; font-weight: 600;">數量</th>
                                <th style="padding: 0.75rem; text-align: right; color: #64748b; font-weight: 600;">單價</th>
                                <th style="padding: 0.75rem; text-align: right; color: #64748b; font-weight: 600;">費用</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 0.75rem; color: #1e293b;">輸入 Token</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;" id="inputTokensTable">0</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;">$3.00 / 1M</td>
                                <td style="padding: 0.75rem; text-align: right; color: #10b981; font-weight: 600;" id="inputCost">$0.00</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 0.75rem; color: #1e293b;">輸出 Token</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;" id="outputTokensTable">0</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;">$15.00 / 1M</td>
                                <td style="padding: 0.75rem; text-align: right; color: #10b981; font-weight: 600;" id="outputCost">$0.00</td>
                            </tr>
                            <tr style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); font-weight: 700;">
                                <td colspan="3" style="padding: 1rem; color: #065f46;">總計獲利</td>
                                <td style="padding: 1rem; text-align: right; color: #065f46; font-size: 1.2rem;" id="totalRevenue">$0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/fhir-connection.js"></script>
    <script src="js/cql-engine.js"></script>
    <script src="js/public-health.js"></script>
    <script src="js/llm-service.js"></script>
    <script src="js/llm-connection-manager.js"></script>
</body>
</html>
