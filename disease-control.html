<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>疾管儀表板 - FHIR CQL Platform</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/llm-connection.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-heartbeat"></i>
                <span>FHIR CQL Platform</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">首頁</a></li>
                <li><a href="disease-control.html" class="active">傳染病管制</a></li>
                <li><a href="public-health.html">國民健康</a></li>
                <li><a href="esg-indicators.html">ESG指標</a></li>
                <li><a href="quality-indicators.html">醫療品質</a></li>
            </ul>
            <div class="nav-settings" onclick="openLLMSettingsModal()" style="cursor: pointer;" title="LLM設定">
                <i class="fas fa-cog"></i>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <main class="main-content">
        <!-- 頁面標題 -->
        <section class="page-header">
            <div class="header-content">
                <h1><i class="fas fa-virus"></i> 疾病管制儀表板</h1>
                <p>傳染病監測與流行病學分析系統</p>
            </div>
            <div class="header-actions" style="position: relative;">
                <div style="display: flex; flex-direction: column; align-items: center; margin-right: 10px;">
                    <button class="btn btn-secondary" onclick="toggleDemoMode()" id="demoModeBtn">
                        <i class="fas fa-flask"></i> <span id="demoModeText">啟用示範模式</span>
                    </button>
                    <div style="font-size: 11px; color: #64748b; margin-top: 4px; text-align: center; line-height: 1.3;">
                        <span style="color: #10b981; font-weight: 600;">●</span> 綠色亮起：模擬資料<br>
                        <span style="color: #94a3b8; font-weight: 600;">●</span> 灰色熄滅：FHIR資料
                    </div>
                </div>
                <button class="btn btn-success" onclick="toggleMapMode()" id="mapModeBtn" style="margin-right: 10px; background: linear-gradient(135deg, #3b82f6, #2563eb);">
                    <i class="fas fa-map-marked-alt"></i> <span id="mapModeText">Google Map</span>
                </button>
                <button class="btn btn-primary" onclick="refreshAllData()">
                    <i class="fas fa-sync-alt"></i> 重新整理
                </button>
            </div>
        </section>

        <!-- FHIR 連線狀態 -->
        <section class="connection-banner" id="connectionBanner">
            <div class="banner-content">
                <i class="fas fa-exclamation-triangle"></i>
                <span>請先在首頁設定 FHIR 伺服器連線</span>
                <a href="index.html" class="btn btn-sm">前往設定</a>
            </div>
        </section>

        <!-- 快速測試區 - 已移除 -->

        <!-- 地圖模式區域 -->
        <section class="map-section" id="mapSection" style="display: none;">
            <!-- 疾病選擇器 -->
            <div class="disease-selector" style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">
                    <i class="fas fa-filter"></i> 選擇要顯示的疾病
                </h3>
                <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: center;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.95rem;">
                        <input type="checkbox" id="mapCovid19" value="covid19" onchange="updateMapDisplay()" 
                               style="width: 18px; height: 18px; margin-right: 0.5rem; cursor: pointer;">
                        <span style="color: #ef4444; font-weight: 600;">🦠 COVID-19</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.95rem;">
                        <input type="checkbox" id="mapInfluenza" value="influenza" onchange="updateMapDisplay()" 
                               style="width: 18px; height: 18px; margin-right: 0.5rem; cursor: pointer;">
                        <span style="color: #3b82f6; font-weight: 600;">🤧 流感</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.95rem;">
                        <input type="checkbox" id="mapConjunctivitis" value="conjunctivitis" onchange="updateMapDisplay()" 
                               style="width: 18px; height: 18px; margin-right: 0.5rem; cursor: pointer;">
                        <span style="color: #f59e0b; font-weight: 600;">👁️ 急性結膜炎</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.95rem;">
                        <input type="checkbox" id="mapEnterovirus" value="enterovirus" onchange="updateMapDisplay()" 
                               style="width: 18px; height: 18px; margin-right: 0.5rem; cursor: pointer;">
                        <span style="color: #8b5cf6; font-weight: 600;">✋ 腸病毒</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.95rem;">
                        <input type="checkbox" id="mapDiarrhea" value="diarrhea" onchange="updateMapDisplay()" 
                               style="width: 18px; height: 18px; margin-right: 0.5rem; cursor: pointer;">
                        <span style="color: #10b981; font-weight: 600;">🦠 腹瀉群聚</span>
                    </label>
                    
                    <!-- 全部查詢按鈕 -->
                    <button class="btn btn-primary" onclick="executeAllCQL()" id="btnExecuteAll" 
                            style="margin-left: auto; padding: 0.6rem 1.5rem; font-size: 0.95rem; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);">
                        <i class="fas fa-rocket"></i> 全部查詢 (5個CQL)
                    </button>
                </div>
                
                <!-- 查詢進度顯示 -->
                <div id="queryProgress" style="display: none; margin-top: 1rem; padding: 0.8rem 1rem; background: linear-gradient(135deg, #eff6ff, #dbeafe); border-left: 4px solid #3b82f6; border-radius: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span style="color: #1e40af; font-weight: 600; font-size: 0.95rem;">
                            <i class="fas fa-spinner fa-spin"></i> <span id="queryProgressText">正在查詢中...</span>
                        </span>
                        <span style="color: #3b82f6; font-weight: 700; font-size: 1.1rem;" id="queryProgressCount">0/5</span>
                    </div>
                    <div style="margin-top: 0.5rem; height: 6px; background: #dbeafe; border-radius: 3px; overflow: hidden;">
                        <div id="queryProgressBar" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>

            <!-- 地圖容器 -->
            <div id="diseaseMap" style="height: 600px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
            
            <!-- 地圖說明 -->
            <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">
                    <i class="fas fa-info-circle"></i> 地圖說明
                </h3>
                <div style="color: #64748b; font-size: 0.9rem; line-height: 1.8;">
                    <div><strong>圓圈大小:</strong> 代表該地區病例數量</div>
                    <div><strong>顏色:</strong> 不同疾病使用不同顏色區分</div>
                    <div><strong>點擊圓圈:</strong> 查看該城市的詳細資訊</div>
                    <div><strong>多疾病叠加:</strong> 可同時勾選多個疾病進行比較</div>
                </div>
            </div>
        </section>

        <!-- 疾病監控總覽 -->
        <section class="overview-section" id="overviewSection">
            <div class="overview-grid">
                <!-- COVID-19 -->
                <div class="overview-card covid">
                    <div class="card-icon">
                        <i class="fas fa-virus"></i>
                    </div>
                    <div class="card-content">
                        <h3>COVID-19</h3>
                        <p class="card-code">InfectiousDisease_COVID19_Surveillance</p>
                        <p class="card-description-text">查詢 COVID-19 確診病例、急診就診、住院資料<br><small style="color: #94a3b8;">（最多查詢1000筆）</small></p>
                        
                        <button class="btn-card-mini" onclick="executeCQL('covid19')" id="btnCovid">
                            <i class="fas fa-play"></i> 執行查詢
                        </button>
                        
                        <div class="card-status" id="statusCovid"></div>
                    </div>
                </div>

                <div class="overview-card influenza">
                    <div class="card-icon">
                        <i class="fas fa-disease"></i>
                    </div>
                    <div class="card-content">
                        <h3>流感</h3>
                        <p class="card-code">InfectiousDisease_Influenza_Surveillance</p>
                        <p class="card-description-text">追蹤流感病例、疫苗接種、重症案例<br><small style="color: #94a3b8;">（最多查詢1000筆）</small></p>
                        
                        <button class="btn-card-mini" onclick="executeCQL('influenza')" id="btnInfluenza">
                            <i class="fas fa-play"></i> 執行查詢
                        </button>
                        
                        <div class="card-status" id="statusInfluenza"></div>
                    </div>
                </div>

                <div class="overview-card conjunctivitis">
                    <div class="card-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="card-content">
                        <h3>急性結膜炎</h3>
                        <p class="card-code">InfectiousDisease_AcuteConjunctivitis_Surveillance</p>
                        <p class="card-description-text">急性結膜炎發病監控、紅眼症聚落偵測<br><small style="color: #94a3b8;">（最多查詢1000筆）</small></p>
                        
                        <button class="btn-card-mini" onclick="executeCQL('conjunctivitis')" id="btnConjunctivitis">
                            <i class="fas fa-play"></i> 執行查詢
                        </button>
                        
                        <div class="card-status" id="statusConjunctivitis"></div>
                    </div>
                </div>

                <div class="overview-card enterovirus">
                    <div class="card-icon">
                        <i class="fas fa-hand-dots"></i>
                    </div>
                    <div class="card-content">
                        <h3>腸病毒</h3>
                        <p class="card-code">InfectiousDisease_Enterovirus_Surveillance</p>
                        <p class="card-description-text">腸病毒疫情、手足口症、疱疹性咽峽炎<br><small style="color: #94a3b8;">（最多查詢1000筆）</small></p>
                        
                        <button class="btn-card-mini" onclick="executeCQL('enterovirus')" id="btnEnterovirus">
                            <i class="fas fa-play"></i> 執行查詢
                        </button>
                        
                        <div class="card-status" id="statusEnterovirus"></div>
                    </div>
                </div>

                <div class="overview-card diarrhea">
                    <div class="card-icon">
                        <i class="fas fa-bacteria"></i>
                    </div>
                    <div class="card-content">
                        <h3>腹瀉群聚</h3>
                        <p class="card-code">InfectiousDisease_AcuteDiarrhea_Surveillance</p>
                        <p class="card-description-text">腹瀉疫情、諾羅病毒、輪狀病毒監測<br><small style="color: #94a3b8;">（最多查詢1000筆）</small></p>
                        
                        <button class="btn-card-mini" onclick="executeCQL('diarrhea')" id="btnDiarrhea">
                            <i class="fas fa-play"></i> 執行查詢
                        </button>
                        
                        <div class="card-status" id="statusDiarrhea"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 頁尾 -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 FHIR CQL Platform. All rights reserved.</p>
            <p>疾病管制儀表板 v1.0 - Powered by FHIR 4.0.1 & CQL Engine</p>
        </div>
    </footer>

    <!-- 詳細數據模態框 -->
    <div class="detail-modal" id="detailModal">
        <div class="detail-modal-content">
            <div class="detail-modal-header">
                <h2 id="modalTitle"><i class="fas fa-virus"></i> COVID-19 詳細數據</h2>
                <button class="modal-close-btn" onclick="closeDetailModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="detail-modal-body">
                <div class="detail-distribution">
                    <h3><i class="fas fa-calendar-alt"></i> 患者年度分布</h3>
                    <div id="yearPatientDistributionChart" class="year-distribution-chart"></div>
                </div>
                
                <div class="detail-distribution">
                    <h3><i class="fas fa-chart-bar"></i> 年齡分布（5歲分組）</h3>
                    <div class="age-distribution-container">
                        <div class="age-chart-wrapper">
                            <div class="age-chart-section">
                                <h4 class="year-chart-title">2024年</h4>
                                <div id="ageChart2024" class="age-chart-bars"></div>
                            </div>
                            <div class="age-chart-section">
                                <h4 class="year-chart-title">2025年</h4>
                                <div id="ageChart2025" class="age-chart-bars"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-actions">
                    <button class="btn btn-primary" onclick="executeCQLFromModal()">
                        <i class="fas fa-sync-alt"></i> 重新查詢
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CQL 查看模態框 -->
    <div id="cqlModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-code"></i> CQL 查詢語言</h3>
                <span class="modal-close" onclick="closeCQLModal()">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="cqlCode"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCQLModal()">關閉</button>
                <button class="btn btn-primary" onclick="copyCQL()">
                    <i class="fas fa-copy"></i> 複製程式碼
                </button>
            </div>
        </div>
    </div>

    <!-- LLM 設定模態框 -->
    <div id="llmSettingsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
                <h3><i class="fas fa-brain"></i> LLM 連線控制台 - 傳染病管制儀表板</h3>
                <span class="modal-close" onclick="closeLLMSettingsModal()" style="color: white;">&times;</span>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <!-- LLM 服務控制 -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: #1e293b;">
                            <i class="fas fa-power-off"></i> 服務控制
                        </h4>
                        <div style="display: flex; gap: 0.75rem;">
                            <button id="uiConnectBtn" onclick="toggleUIConnection()" class="btn-external-service inactive">
                                <i class="fas fa-window-restore"></i> <span>連線 UI/UX</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 四節點連接狀態圖 -->
                    <div class="llm-connection-flow">
                        <div class="connection-flow-header">
                            <h5>連接狀態</h5>
                        </div>
                        
                        <div class="connection-nodes-container">
                            <!-- FHIR 伺服器 -->
                            <div class="connection-node node-fhir">
                                <div class="node-circle">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">FHIR</div>
                                    <div class="node-subtitle">伺服器</div>
                                </div>
                            </div>
                            
                            <!-- 連接線 1: FHIR → 控制網頁 -->
                            <div class="connection-line-wrapper">
                                <div class="connection-line line-fhir-control connected"></div>
                            </div>
                            
                            <!-- 控制網頁 -->
                            <div class="connection-node node-control">
                                <div class="node-circle">
                                    <i class="fas fa-desktop"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">控制網頁</div>
                                    <div class="node-subtitle">醫護人員</div>
                                </div>
                            </div>
                            
                            <!-- 連接線 2: 控制網頁 → 民眾網頁 -->
                            <div class="connection-line-wrapper">
                                <div class="connection-line line-control-public disconnected"></div>
                            </div>
                            
                            <!-- 民眾網頁 -->
                            <div class="connection-node node-public">
                                <div class="node-circle">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">民眾網頁</div>
                                    <div class="node-subtitle">公開版</div>
                                </div>
                            </div>
                            
                            <!-- 連接線 3: 民眾網頁 → LLM -->
                            <div class="connection-line-wrapper">
                                <div class="connection-line line-public-llm disconnected"></div>
                            </div>
                            
                            <!-- LLM 智能模型 -->
                            <div class="connection-node node-llm">
                                <div class="node-circle">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">LLM</div>
                                    <div class="node-subtitle">智能模型</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 狀態訊息 -->
                        <div id="llmConnectionMessage" class="connection-status-message info">
                            <i class="fas fa-info-circle"></i> 預設狀態：FHIR ↔ 網頁 | 網頁 ✕ LLM
                        </div>
                    </div>
                    
                    <!-- 說明文字 -->
                    <div style="margin-top: 1rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <p style="margin: 0 0 0.5rem 0; color: #1e40af; font-weight: 600; font-size: 0.9rem;">
                            <i class="fas fa-lightbulb"></i> 外部服務模式說明：
                        </p>
                        <ul style="margin: 0; padding-left: 1.5rem; color: #1e40af; font-size: 0.85rem; line-height: 1.6;">
                            <li>啟動後將開啟民眾版網頁（僅顯示匿名統計數據）</li>
                            <li>系統自動進行數據去識別化處理，保護病患隱私</li>
                            <li>控制台仍可正常查詢 FHIR（不影響內部作業）</li>
                            <li>LLM 僅接收統計數據，提供公共健康趨勢分析</li>
                        </ul>
                    </div>
                </div>
                
                <!-- 使用狀態 -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 1rem 0; color: #1e293b;">
                        <i class="fas fa-chart-line"></i> 即時使用狀態
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 0.75rem; color: #1e40af; margin-bottom: 0.3rem;">查詢次數</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af;" id="queryCount">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-size: 0.75rem; color: #065f46; margin-bottom: 0.3rem;">輸入 Token</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #065f46;" id="inputTokens">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 0.75rem; color: #92400e; margin-bottom: 0.3rem;">輸出 Token</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #92400e;" id="outputTokens">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); padding: 1rem; border-radius: 8px; border-left: 4px solid #ec4899;">
                            <div style="font-size: 0.75rem; color: #831843; margin-bottom: 0.3rem;">資料傳輸</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #831843;" id="dataTransfer">0 KB</div>
                        </div>
                    </div>
                </div>
                
                <!-- 獲利金額 -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 1rem 0; color: #1e293b;">
                        <i class="fas fa-dollar-sign"></i> 獲利金額 (USD)
                    </h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 0.75rem; text-align: left; color: #64748b; font-weight: 600;">項目</th>
                                <th style="padding: 0.75rem; text-align: right; color: #64748b; font-weight: 600;">數量</th>
                                <th style="padding: 0.75rem; text-align: right; color: #64748b; font-weight: 600;">單價</th>
                                <th style="padding: 0.75rem; text-align: right; color: #64748b; font-weight: 600;">費用</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 0.75rem; color: #1e293b;">輸入 Token</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;" id="inputTokensTable">0</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;">$3.00 / 1M</td>
                                <td style="padding: 0.75rem; text-align: right; color: #10b981; font-weight: 600;" id="inputCost">$0.00</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 0.75rem; color: #1e293b;">輸出 Token</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;" id="outputTokensTable">0</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;">$15.00 / 1M</td>
                                <td style="padding: 0.75rem; text-align: right; color: #10b981; font-weight: 600;" id="outputCost">$0.00</td>
                            </tr>
                            <tr style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); font-weight: 700;">
                                <td colspan="3" style="padding: 1rem; color: #065f46;">總計獲利</td>
                                <td style="padding: 1rem; text-align: right; color: #065f46; font-size: 1.2rem;" id="totalRevenue">$0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/main.js"></script>
    <script src="js/fhir-connection.js"></script>
    <script src="js/dashboard-simple.js"></script>
    <script src="js/llm-service.js"></script>
    <script src="js/llm-connection-manager.js"></script>
</body>
</html>
