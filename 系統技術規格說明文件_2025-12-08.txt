===============================================
醫療品質指標 FHIR Dashboard 系統
技術規格說明文件
===============================================

文件版本：1.0
更新日期：2025-12-08
專案狀態：開發完成，測試資料準備中


===============================================
一、系統概述
===============================================

系統名稱：Taiwan Healthcare Quality Indicators FHIR Dashboard
系統類型：Web-based 醫療品質指標視覺化平台
開發目的：整合 FHIR R4 標準，計算並展示台灣醫療品質指標

核心功能：
  1. FHIR R4 資料整合與查詢
  2. CQL (Clinical Quality Language) 指標計算引擎
  3. 29 個醫療品質指標即時計算
  4. 互動式 Dashboard 視覺化展示
  5. SMART on FHIR 授權整合


===============================================
二、技術架構
===============================================

【前端技術】
  - HTML5 / CSS3 / JavaScript (ES6+)
  - Bootstrap 5.3.0 (響應式框架)
  - Chart.js 4.4.0 (圖表視覺化)
  - jQuery 3.6.0 (DOM 操作)
  - Font Awesome 6.4.0 (圖示系統)

【後端整合】
  - FHIR R4 REST API
  - CQL Engine (JavaScript 實現)
  - SMART on FHIR 授權流程
  - OAuth 2.0 認證機制

【資料標準】
  - FHIR R4 (Fast Healthcare Interoperability Resources)
  - CQL 1.5 (Clinical Quality Language)
  - ICD-10-CM 診斷編碼
  - NHI 台灣健保給付碼
  - SNOMED CT 臨床術語
  - LOINC 檢驗檢查碼
  - ATC 藥品分類碼

【支援瀏覽器】
  - Chrome 90+ (建議使用)
  - Edge 90+
  - Firefox 88+
  - Safari 14+


===============================================
三、系統架構圖
===============================================

┌─────────────────────────────────────────┐
│         使用者介面 (Web Browser)         │
│  • Dashboard 主控台                      │
│  • 指標計算器                            │
│  • 資料視覺化                            │
└──────────────┬──────────────────────────┘
               │ HTTPS
               ▼
┌─────────────────────────────────────────┐
│        前端應用層 (JavaScript)           │
│  • FHIR Client                          │
│  • CQL Engine                           │
│  • Chart.js 視覺化                       │
│  • SMART Launch Handler                │
└──────────────┬──────────────────────────┘
               │ REST API
               ▼
┌─────────────────────────────────────────┐
│       FHIR R4 伺服器                     │
│  • Patient 病患資源                      │
│  • Observation 觀察值                    │
│  • Condition 診斷                        │
│  • MedicationRequest 用藥                │
│  • Procedure 處置                        │
│  • Encounter 就診                        │
└─────────────────────────────────────────┘


===============================================
四、功能模組
===============================================

【模組 1：傳染病管制指標】
  檔案：public-health.html
  指標數量：5 個
  涵蓋項目：
    - COVID-19 確診通報
    - 流感疫苗接種率
    - 結核病篩檢
    - 腸病毒監測
    - 疫苗接種完整性

【模組 2：ESG 永續指標】
  檔案：esg-indicators.html
  指標數量：3 個
  涵蓋項目：
    - 抗生素合理使用
    - 醫療廢棄物管理
    - 能源效率指標

【模組 3：用藥安全指標】
  檔案：quality-indicators.html (03系列)
  指標數量：10 個
  涵蓋項目：
    - 同院用藥重疊 (8種藥物類別)
    - 門診注射抗生素使用
    - 慢性病連續處方

【模組 4：門診品質指標】
  檔案：quality-indicators.html (08系列)
  指標數量：5 個
  涵蓋項目：
    - 慢性處方箋使用率
    - 多重用藥管理
    - 急診重複就診
    - 檢驗重複率

【模組 5：住院品質指標】
  檔案：quality-indicators.html (09-10系列)
  指標數量：2 個
  涵蓋項目：
    - 3日內急診再入院率
    - 住院死亡率

【模組 6：手術品質指標】
  檔案：quality-indicators.html (11-15系列)
  指標數量：4 個
  涵蓋項目：
    - 剖腹產率 (初產婦、有適應症)
    - 手術傷口感染
    - 膝關節置換術後感染

【模組 7：疾病管理指標】
  檔案：disease-control.html
  指標數量：6 個
  涵蓋項目：
    - 糖尿病 HbA1c 控制
    - 高血壓控制
    - 失智症安寧療護
    - 體外震波碎石術成效


===============================================
五、資料資源統計
===============================================

【測試資料總量】
  總病患數：645 人 (保守估計)
  實際範圍：650-850 人
  總資源數：約 3,131 個 FHIR 資源
  資料期間：2025 Q4 (2025-10-01 至 2025-12-31)

【資料分類】
  A. CGMH 大批測試資料
     病患數：508 人
     資源數：2,457 個
     檔案數：10 個 Bundle
     病患 ID：TW00001 ~ TW00507
     涵蓋指標：29 個

  B. HAPI 小批測試資料
     病患數：49 人
     資源數：約 298 個
     檔案數：9 個 Bundle
     特殊病人：Mr. FHIR CQL (1歲示範病人)

  C. Dashboard 測試資料
     病患數：64 人
     資源數：226 個
     檔案數：7 個 Bundle
     重點指標：03-1, 11-3, 11-4, 15-1

  D. 根目錄測試資料
     病患數：24 人
     資源數：約 150 個
     檔案數：7 個 Bundle

【FHIR 資源類型分布】
  - Patient (病患)：約 645 個
  - Encounter (就診)：約 800 個
  - Condition (診斷)：約 700 個
  - MedicationRequest (用藥)：約 900 個
  - Observation (觀察值)：約 300 個
  - Procedure (處置)：約 150 個
  - Immunization (疫苗)：約 130 個


===============================================
六、指標計算引擎
===============================================

【CQL 引擎規格】
  版本：CQL 1.5
  實作方式：JavaScript Native Implementation
  計算模式：客戶端即時計算

【指標計算流程】
  1. FHIR 資料查詢
     ↓
  2. 資源過濾與分組
     ↓
  3. CQL 邏輯執行
     ↓
  4. 分子/分母計算
     ↓
  5. 指標值輸出
     ↓
  6. 視覺化展示

【效能指標】
  - 單一指標計算時間：< 2 秒
  - Dashboard 完整載入：< 5 秒
  - 資料查詢延遲：< 1 秒
  - 圖表渲染時間：< 500ms


===============================================
七、FHIR 伺服器整合
===============================================

【支援的 FHIR Server】
  1. 台灣衛福部 FHIR Server (官方測試環境) ⚠️ 不穩定
     URL: https://thas.mohw.gov.tw/v/r4/fhir
     狀態：CORS 封鎖 (2025-12-08 下午發現問題)
     說明：早上可用，下午開始拒絕跨域請求，可能定期清空資料 (保留 6 個月)
     錯誤：Access-Control-Allow-Origin header 缺失

  2. SMART Health IT R4 ⭐ 目前推薦
     URL: https://r4.smarthealthit.org
     狀態：正常運作
     說明：公開測試伺服器，穩定可靠

  3. Firely Server ⭐ 目前推薦
     URL: https://server.fire.ly/r4
     狀態：正常運作
     說明：國際測試環境，穩定可靠

  4. HAPI FHIR R4
     URL: https://hapi.fhir.org/baseR4
     狀態：失效 (404 Not Found)
     說明：已於 2025-12 移除

  5. 自訂伺服器
     可透過 UI 手動輸入

【FHIR API 操作】
  支援方法：
    - GET /Patient
    - GET /Observation
    - GET /Condition
    - GET /MedicationRequest
    - GET /Procedure
    - GET /Encounter
    - GET /Immunization
    - POST / (Bundle transaction)

  查詢參數：
    - _count (分頁)
    - _sort (排序)
    - date (日期範圍)
    - patient (病患篩選)
    - code (編碼篩選)


===============================================
八、安全性與隱私
===============================================

【認證機制】
  - SMART on FHIR OAuth 2.0
  - Launch Context 傳遞
  - Access Token 管理
  - Session 狀態維護

【資料安全】
  - HTTPS 加密傳輸
  - 無本地儲存敏感資料
  - CORS 跨域保護
  - XSS 防護

【隱私保護】
  - 去識別化測試資料
  - 無真實病患資訊
  - 符合 HIPAA 精神
  - 符合台灣個資法


===============================================
九、部署環境
===============================================

【開發環境】
  作業系統：Windows 11
  開發工具：VS Code
  版本控制：Git 2.52.0
  測試瀏覽器：Chrome 131

【測試環境】
  FHIR Server：台灣衛福部測試環境
  資料量：645 位病患，3,131 資源
  網路環境：需穩定網際網路連線

【生產環境建議】
  Web Server：Nginx 1.24+ 或 Apache 2.4+
  HTTPS：必須啟用 SSL/TLS
  CDN：建議使用 (Bootstrap, jQuery 等)
  監控：錯誤日誌記錄


===============================================
十、檔案結構
===============================================

FHIR-Dashboard-App/
├── index.html                      (首頁/登入頁)
├── navigation.html                 (導航列)
├── launch.html                     (SMART Launch 進入點)
├── smart-launch.js                 (SMART 認證邏輯)
├── public-health.html              (傳染病指標)
├── esg-indicators.html             (ESG 指標)
├── quality-indicators.html         (醫療品質指標)
├── disease-control.html            (疾病管理指標)
├── privacy.html                    (隱私權政策)
├── README.md                       (專案說明)
├── 測試資料/
│   ├── ESWL_5_Patients.json
│   ├── Surgical_Wound_Infection_15_Patients.json
│   ├── Dementia_Hospice_19_Patients.json
│   ├── Knee_Arthroplasty_Infection_5_Patients.json
│   ├── First_Time_Cesarean_11_Patients.json
│   ├── Cesarean_With_Indication_5_Patients.json
│   └── Same_Hospital_Antihypertensive_Overlap_4_Patients.json
└── 上傳腳本/
    ├── upload_all_64_patients.ps1
    └── upload_*.ps1 (各指標上傳腳本)


===============================================
十一、上傳工具
===============================================

【批次上傳腳本】
  1. UPLOAD_ALL_650-850_PATIENTS.ps1  (全自動上傳)
     - 上傳所有 33 個檔案
     - 自動計時和進度顯示
     - 預計時間：50-60 分鐘

  2. upload_all_cgmh_508.ps1          (CGMH 批次上傳)
     - 上傳 10 個 CGMH Bundle
     - 508 位病患，2,457 資源

  3. upload_all_64_patients.ps1       (Dashboard 批次上傳)
     - 上傳 7 個指標檔案
     - 64 位病患，226 資源

  4. upload_all_root_24.ps1           (根目錄批次上傳)
     - 執行 5 個 Python 上傳腳本
     - 24 位病患

【單一指標上傳腳本】
  - upload_eswl.ps1
  - upload_surgical_wound_infection.ps1
  - upload_dementia_hospice.ps1
  - upload_knee_arthroplasty_infection.ps1
  - upload_same_hospital_antihypertensive_overlap.ps1
  - upload_cesarean_with_indication.ps1
  - upload_first_time_cesarean.ps1


===============================================
十二、資料打包
===============================================

【完整資料包】
  資料夾：FHIR_測試資料_完整包_645人_2025-12-08
  
  結構：
    ├── README.md (完整說明)
    ├── A_CGMH大批資料_508人/ (10 個檔案)
    ├── B_HAPI小批資料_49人/ (9 個檔案)
    ├── C_Dashboard資料_64人/ (7 個檔案)
    └── D_根目錄測試_24人/ (7 個檔案)

  規格：
    - 總檔案數：33 個 JSON + 1 個說明文件
    - 資料夾大小：3.24 MB
    - 格式：FHIR R4 Bundle (transaction)

【交付內容】
  1. 所有 JSON Bundle 檔案
  2. 完整上傳說明文件
  3. PowerShell 批次上傳腳本
  4. Bash 跨平台上傳腳本
  5. 檢查清單和驗證步驟


===============================================
十三、品質指標清單
===============================================

【傳染病管制 (5個)】
  PH-01  COVID-19 確診通報完整率
  PH-02  流感疫苗接種率
  PH-03  結核病篩檢率
  PH-04  腸病毒通報率
  PH-05  疫苗接種完整性

【ESG 永續 (3個)】
  ESG-01 抗生素合理使用率
  ESG-02 醫療廢棄物減量率
  ESG-03 能源效率指標

【用藥安全 (10個)】
  03-1   同院降血壓藥重疊 (1710)
  03-2   同院降血糖藥重疊
  03-3   同院抗凝血藥重疊
  03-4   同院抗血小板藥重疊
  03-5   同院降血脂藥重疊
  03-6   同院胃藥重疊
  03-7   同院安眠藥重疊
  03-8   同院抗生素重疊
  08-1   門診注射抗生素使用率
  08-2   慢性病連續處方箋使用率

【門診品質 (5個)】
  08-3   多重用藥管理率
  08-4   急診當日重複就診率
  08-5   檢驗重複執行率
  08-6   影像檢查重複率
  08-7   用藥遵從性

【住院品質 (2個)】
  09-1   3日內急診再入院率 (1717)
  10-1   住院死亡率

【手術品質 (4個)】
  11-3   有適應症剖腹產率 (1138.01)
  11-4   初產婦剖腹產率 (1075.01)
  14-1   手術傷口感染率
  15-1   膝關節置換90日內深部感染率 (353.01)

【疾病管理 (6個)】
  DM-01  糖尿病 HbA1c 控制達標率
  DM-02  糖尿病血壓控制率
  HTN-01 高血壓控制達標率
  DEM-01 失智症安寧療護率
  URO-01 體外震波碎石術有效率
  CHF-01 心衰竭再入院率


===============================================
十四、編碼標準對照
===============================================

【診斷編碼】
  標準：ICD-10-CM
  範例：
    - E11.9  第二型糖尿病
    - I10    原發性高血壓
    - G30.9  阿茲海默症
    - F03.90 失智症
    - O82.0  剖腹產分娩
    - T81.4  手術傷口感染
    - T84.54 膝關節假體感染

【處置編碼】
  標準：台灣健保給付碼 (NHI) + ICD-10-PCS
  範例：
    - 81004C  剖腹產術
    - 81028C  剖腹產術(有併發症)
    - 64164B  全膝關節置換術
    - 76021B  體外震波碎石術

【藥品編碼】
  標準：ATC (Anatomical Therapeutic Chemical)
  範例：
    - C07     β阻斷劑
    - C09     ACE抑制劑/ARB
    - C08     鈣離子阻斷劑
    - C03     利尿劑
    - A10     降血糖藥
    - J01     抗生素

【檢驗編碼】
  標準：LOINC
  範例：
    - 4548-4  HbA1c (糖化血色素)
    - 8480-6  收縮壓
    - 8462-4  舒張壓


===============================================
十五、系統限制與已知問題
===============================================

【技術限制】
  1. 客戶端計算：大量資料可能影響效能
  2. 瀏覽器相容：需現代瀏覽器支援
  3. 網路依賴：需穩定連線至 FHIR Server
  4. 即時性：資料更新依賴 FHIR Server

【已知問題】
  1. HAPI FHIR 公開伺服器已失效 (404)
  2. 台灣衛福部 FHIR Server 查詢偶有逾時
  3. Sand-Box 環境可能定期清空資料 (保留 6 個月)
  4. JSON 檔案 UTF-8 BOM 編碼問題 (已修正)

【待改進項目】
  1. 後端 CQL Engine 整合 (提升效能)
  2. 資料快取機制 (減少查詢次數)
  3. 離線模式支援
  4. 匯出報表功能
  5. 多語言介面 (目前僅繁體中文)


===============================================
十六、備援方案
===============================================

【GitHub Pages 靜態 API】
  目的：應對外部 FHIR Server 不穩定
  方案：
    - 建立 GitHub Repository 託管 JSON 資料
    - 啟用 GitHub Pages 提供靜態 API
    - 前端新增伺服器選項切換
    - 100% 可用性，零成本

  優點：
    ✓ 完全控制資料
    ✓ 不受外部伺服器影響
    ✓ 全球 CDN 加速
    ✓ 完整版本控制

  缺點：
    ✗ 唯讀 (無法 POST/PUT/DELETE)
    ✗ 搜尋需客戶端實現

  狀態：已完成評估，待實施


===============================================
十七、測試與驗證
===============================================

【單元測試】
  - CQL 引擎邏輯測試
  - FHIR 資料解析測試
  - 指標計算正確性驗證

【整合測試】
  - FHIR Server 連線測試
  - SMART Launch 流程測試
  - 完整資料上傳測試

【使用者測試】
  - Dashboard 介面操作
  - 指標計算結果驗證
  - 跨瀏覽器相容性測試

【效能測試】
  - 645 位病患資料載入
  - 29 個指標同時計算
  - 圖表渲染效能


===============================================
十八、文件清單
===============================================

【技術文件】
  1. 系統技術規格說明文件_2025-12.txt (本文件)
  2. GitHub_FHIR_Server_部署方案評估.md
  3. GitHub_Pages_首頁展示方案.md
  4. GitHub_類似伺服器製作方案評估.md

【操作文件】
  1. 給對方上傳_完整病人資料包說明.md
  2. 打包清單_所有測試資料.md
  3. 測試資料總清單_完整版.md
  4. 模擬病人資料清單.md

【專案文件】
  1. README.md (專案總覽)
  2. QUICK_START_GUIDE.md (快速開始)
  3. STARTUP_GUIDE.md (啟動指南)
  4. RESTORE_INSTRUCTIONS.md (備份還原)

【指標文件】
  1. MEDICAL_QUALITY_INDICATORS_MAPPING.md
  2. PUBLIC_HEALTH_CQL_STATUS.md
  3. ESG_CQL_STATUS.md
  4. CQL_INTEGRATION_STATUS.md
  5. ALL_INDICATORS_COMPLETE_SUMMARY.md

【驗證報告】
  1. INDICATORS_01-04_SUMMARY.md
  2. INDICATORS_03-3_TO_03-6_VERIFICATION.md
  3. INDICATORS_03-7_TO_03-14_VERIFICATION.md
  4. INDICATORS_03-15_TO_08_VERIFICATION.md
  5. INDICATORS_09-13_VERIFICATION.md
  6. INDICATORS_14-19_VERIFICATION.md
  7. QUALITY_INDICATORS_VERIFICATION.md


===============================================
十九、專案時程
===============================================

【開發階段】
  2024-11 ~ 2024-12  前端介面開發
  2024-12 ~ 2025-01  FHIR 整合
  2025-01 ~ 2025-02  CQL 引擎開發
  2025-02 ~ 2025-03  指標邏輯實作

【測試階段】
  2025-03 ~ 2025-04  單元測試
  2025-04 ~ 2025-05  整合測試
  2025-05 ~ 2025-06  使用者測試

【資料準備】
  2025-11-26         備份檔案救回
  2025-12-02         CGMH 508 人資料上傳
  2025-12-05         小批測試資料上傳
  2025-12-08         完整打包 (645 人)

【目前狀態】
  開發完成度：95%
  測試完成度：80%
  資料準備度：100%
  部署準備度：90%


===============================================
二十、聯絡資訊
===============================================

【開發團隊】
  專案負責人：Tony
  開發環境：Windows 11
  工作目錄：c:\Users\tony1\Desktop\UI UX-20251122(0013)

【技術支援】
  Email：待補充
  GitHub：待補充
  文件位置：專案根目錄

【問題回報】
  1. 錯誤截圖
  2. Console 錯誤訊息
  3. FHIR Server 回應
  4. 瀏覽器版本


===============================================
二十一、智慧財產權
===============================================

【著作權】
  © 2024-2025 Taiwan Healthcare Quality Indicators Project
  All Rights Reserved

【授權方式】
  待確認

【專利申請】
  申請編號：______________

【第三方套件授權】
  - Bootstrap 5.3.0      MIT License
  - Chart.js 4.4.0       MIT License
  - jQuery 3.6.0         MIT License
  - Font Awesome 6.4.0   Font Awesome Free License

【資料來源】
  - FHIR® is a registered trademark of HL7
  - ICD-10-CM © WHO
  - SNOMED CT © IHTSDO
  - LOINC® © Regenstrief Institute


===============================================
二十二、附錄
===============================================

【A. FHIR 資源範例】
見專案目錄：test_data_*.json

【B. CQL 查詢範例】
見各指標 HTML 檔案內嵌 JavaScript

【C. 上傳腳本範例】
見專案目錄：upload_*.ps1, upload_*.py

【D. API 測試指令】
見 README.md 和各說明文件

【E. 錯誤代碼對照表】
  400 Bad Request     - 資料格式錯誤
  401 Unauthorized    - 未授權存取
  404 Not Found       - 資源不存在
  500 Internal Error  - 伺服器錯誤
  503 Service Unavail - 服務暫時無法使用


===============================================
文件結束
===============================================

最後更新：2025-12-08
版本：1.0
狀態：正式版
