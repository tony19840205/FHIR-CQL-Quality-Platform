// ========== ç–¾ç®¡å„€è¡¨æ¿é‚è¼¯ ==========

let trendChart, sourceChart, ageChart;
let currentResults = {};

// é é¢è¼‰å…¥
document.addEventListener('DOMContentLoaded', function() {
    console.log('========================================');
    console.log('ç–¾ç®¡å„€è¡¨æ¿å·²è¼‰å…¥');
    console.log('========================================');
    
    // åˆå§‹åŒ–æ‰€æœ‰å¡ç‰‡é¡¯ç¤ºç‚º 0
    initializeOverviewCards();
    
    // å¾ localStorage è¼‰å…¥ FHIR é€£ç·šè¨­å®š
    const savedServer = localStorage.getItem('fhirServer');
    const savedToken = localStorage.getItem('authToken');
    
    console.log('ğŸ“¡ å¾ localStorage è¼‰å…¥è¨­å®š:');
    console.log('  - Server:', savedServer);
    console.log('  - Token:', savedToken ? 'å·²è¨­å®š' : 'æœªè¨­å®š');
    
    // ç­‰å¾… fhirConnection åˆå§‹åŒ–
    setTimeout(() => {
        // å‰µå»ºå…¨åŸŸ FHIR é€£ç·šå¯¦ä¾‹
        if (typeof FHIRConnection !== 'undefined') {
            window.fhirConnection = new FHIRConnection();
            
            // å¦‚æœæœ‰å„²å­˜çš„ä¼ºæœå™¨è¨­å®šï¼Œç›´æ¥ä½¿ç”¨
            if (savedServer) {
                window.fhirConnection.serverUrl = savedServer;
                window.fhirConnection.authToken = savedToken || '';
                window.fhirConnection.isConnected = true;
                
                console.log('âœ… å·²å¾ localStorage æ¢å¾©é€£ç·šè¨­å®š');
                console.log('   Server URL:', savedServer);
            }
        }
        
        // æª¢æŸ¥ FHIR é€£ç·š
        checkFHIRConnection();
        
        // åˆå§‹åŒ– CQL Engine
        if (window.fhirConnection && window.fhirConnection.isConnected) {
            window.cqlEngine = new CQLEngine(window.fhirConnection);
            console.log('âœ“ CQL Engine å·²åˆå§‹åŒ–');
            
            // ä¸å†è‡ªå‹•åŸ·è¡ŒæŸ¥è©¢,ç”±ä½¿ç”¨è€…æ‰‹å‹•é»æ“Š
            console.log('â„¹ï¸ è«‹é»æ“Šå„ç–¾ç—…å¡ç‰‡çš„"åŸ·è¡ŒæŸ¥è©¢"æŒ‰éˆ•é–‹å§‹æŸ¥è©¢');
        } else {
            console.warn('âš  FHIR é€£ç·šæœªå»ºç«‹ï¼Œè«‹å…ˆåˆ°é¦–é è¨­å®šé€£ç·š');
        }
    }, 200);
    
    // åˆå§‹åŒ–åœ–è¡¨
    initCharts();
});

// åˆå§‹åŒ–ç¸½è¦½å¡ç‰‡
function initializeOverviewCards() {
    const cards = ['covid', 'flu', 'conjunctivitis', 'entero', 'diarrhea'];
    
    cards.forEach(card => {
        // åˆå§‹åŒ–ç¸½äººæ•¸é¡¯ç¤º
        const totalElement = document.getElementById(`${card}Total`);
        if (totalElement) {
            totalElement.textContent = '--';
            console.log(`åˆå§‹åŒ–å¡ç‰‡: ${card}Total = --`);
        }
    });
}

// æª¢æŸ¥ FHIR é€£ç·šç‹€æ…‹
async function checkFHIRConnection() {
    console.log('ğŸ“¡ æª¢æŸ¥ FHIR é€£ç·šç‹€æ…‹...');
    const banner = document.getElementById('connectionBanner');
    const quickTestSection = document.getElementById('quickTestSection');
    
    // ç­‰å¾… fhirConnection åˆå§‹åŒ–
    await new Promise(resolve => setTimeout(resolve, 100));
    
    if (!window.fhirConnection || !window.fhirConnection.serverUrl) {
        console.warn('âš  FHIR ä¼ºæœå™¨æœªé€£ç·šæˆ–æœªè¨­å®š');
        if (banner) banner.classList.add('show');
        if (quickTestSection) quickTestSection.style.display = 'none';
        // ç¦ç”¨æ‰€æœ‰åŸ·è¡ŒæŒ‰éˆ•
        disableAllButtons();
    } else {
        console.log('âœ… FHIR ä¼ºæœå™¨å·²é€£ç·š:', window.fhirConnection.serverUrl);
        if (banner) banner.classList.remove('show');
        if (quickTestSection) quickTestSection.style.display = 'block';
        
        // å•Ÿç”¨æ‰€æœ‰æŒ‰éˆ•
        enableAllButtons();
        
        // è‡ªå‹•åŸ·è¡Œå¿«é€Ÿæ¸¬è©¦
        setTimeout(() => testFHIRData(), 500);
    }
}

// è‡ªå‹•æ¸¬è©¦æ‰€æœ‰ CQLï¼ˆä½¿ç”¨çœŸå¯¦ FHIR è³‡æ–™ï¼‰
async function testAllCQL() {
    console.log('\n========================================');
    console.log('ğŸ§ª é–‹å§‹è‡ªå‹•åŸ·è¡Œ COVID-19 æŸ¥è©¢ï¼ˆçœŸå¯¦è³‡æ–™ï¼‰');
    console.log('========================================\n');
    
    // åªåŸ·è¡Œ COVID-19
    const diseases = ['covid19'];
    const diseaseNames = {
        'covid19': 'COVID-19'
    };
    
    // é¡¯ç¤ºæ•´é«”é€²åº¦
    console.log(`ğŸ“Š å°‡å¾ FHIR ä¼ºæœå™¨æŸ¥è©¢çœŸå¯¦è³‡æ–™...`);
    
    // å…ˆæŸ¥è©¢ä¸€æ¬¡ FHIR å–å¾—åŸºç¤è³‡æ–™ï¼ˆçœŸå¯¦è³‡æ–™ä¾†æºï¼‰
    let baseResults = null;
    try {
        const currentServer = localStorage.getItem('fhirServer');
        console.log('ğŸ” æ­£åœ¨å¾ FHIR ä¼ºæœå™¨å–å¾—çœŸå¯¦è³‡æ–™...');
        console.log(`ğŸ“¡ é€£æ¥çš„ä¼ºæœå™¨: ${currentServer}`);
        
        baseResults = await window.cqlEngine.executeCQL('covid19');
        
        const realPatients = baseResults.patients?.length || 0;
        const realEncounters = baseResults.encounters?.length || 0;
        const realConditions = baseResults.conditions?.length || 0;
        const realObservations = baseResults.observations?.length || 0;
        
        console.log('âœ… çœŸå¯¦ FHIR è³‡æ–™å·²å–å¾—ï¼ˆä¾†è‡ªä¼ºæœå™¨ï¼‰:');
        console.log(`   æ‚£è€…: ${realPatients} ä½`);
        console.log(`   å°±è¨ºè¨˜éŒ„: ${realEncounters} ç­†`);
        console.log(`   è¨ºæ–·è¨˜éŒ„: ${realConditions} ç­†`);
        console.log(`   æª¢é©—è¨˜éŒ„: ${realObservations} ç­†`);
        console.log(`   è³‡æ–™ä¾†æº: ${currentServer}`);
        console.log(`   âš ï¸ æ³¨æ„ï¼šé€™æ˜¯å¾ä¼ºæœå™¨å¯¦éš›æŸ¥è©¢åˆ°çš„çœŸå¯¦æ•¸æ“š\n`);
        
        // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºè­¦å‘Š
        if (realPatients === 0 && realEncounters === 0) {
            console.warn('âš ï¸âš ï¸âš ï¸ FHIR ä¼ºæœå™¨æ²’æœ‰ä»»ä½•è³‡æ–™ï¼');
            console.warn('   å¯èƒ½åŸå› ï¼š');
            console.warn('   1. ä¼ºæœå™¨æ˜¯ç©ºçš„ï¼ˆæ²’æœ‰ä¸Šå‚³æ¸¬è©¦è³‡æ–™ï¼‰');
            console.warn('   2. CQL æŸ¥è©¢æ¢ä»¶å¤ªåš´æ ¼ï¼ˆæ²’æœ‰ç¬¦åˆçš„ç—…ä¾‹ï¼‰');
            console.warn('   3. ä¼ºæœå™¨é€£ç·šæœ‰å•é¡Œ');
            console.warn('   å»ºè­°ï¼šåˆ‡æ›åˆ° HAPI FHIR R4 æ¸¬è©¦ä¼ºæœå™¨');
        }
    } catch (error) {
        console.error('âŒ ç„¡æ³•å¾ FHIR ä¼ºæœå™¨å–å¾—è³‡æ–™:', error);
        console.error('   éŒ¯èª¤è¨Šæ¯:', error.message);
        console.error('   è«‹æª¢æŸ¥ï¼š');
        console.error('   1. ä¼ºæœå™¨ URL æ˜¯å¦æ­£ç¢º');
        console.error('   2. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸');
        console.error('   3. ä¼ºæœå™¨æ˜¯å¦æ”¯æ´ FHIR R4');
        return;
    }
    
    // åªè™•ç† COVID-19
    const disease = 'covid19';
    console.log(`\nâ–¶ï¸ è™•ç† ${diseaseNames[disease]}...`);
    
    try {
        // é¡¯ç¤ºå¯¦éš›å¾ FHIR ä¼ºæœå™¨å–å¾—çš„æ•¸æ“š
        const encountersCount = baseResults.encounters?.length || 0;
        const patientsCount = baseResults.patients?.length || 0;
        
        // è¨ˆç®—ä»Šå¤©çš„çœŸå¯¦æ–°å¢æ•¸ï¼ˆæª¢æŸ¥ encounters çš„æ—¥æœŸï¼‰
        const today = new Date();
        const todayDateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
        
        let todayNewCases = 0;
        if (baseResults.encounters) {
            baseResults.encounters.forEach(encounter => {
                const encounterDate = encounter.period?.start || encounter.period?.end;
                if (encounterDate) {
                    const encDateStr = encounterDate.split('T')[0]; // åªæ¯”è¼ƒæ—¥æœŸéƒ¨åˆ†
                    if (encDateStr === todayDateStr) {
                        todayNewCases++;
                    }
                }
            });
        }
        
        console.log(`ğŸ“… ä»Šå¤©æ—¥æœŸ: ${todayDateStr}`);
        console.log(`ğŸ“… ä»Šå¤©æ–°å¢: ${todayNewCases} ç­†ï¼ˆå¯¦éš›çµ±è¨ˆï¼‰`);
        
        // çµ±è¨ˆæ‰€æœ‰å¹´ä»½çš„å°±è¨ºè¨˜éŒ„åˆ†å¸ƒ
        const yearDistribution = {};
        if (baseResults.encounters) {
            baseResults.encounters.forEach(enc => {
                const encDate = enc.period?.start || enc.period?.end;
                if (encDate) {
                    const year = new Date(encDate).getFullYear();
                    yearDistribution[year] = (yearDistribution[year] || 0) + 1;
                }
            });
        }
        
        console.log(`ğŸ“Š å°±è¨ºè¨˜éŒ„å¹´ä»½åˆ†å¸ƒ:`, yearDistribution);
        
        // è¨ˆç®—å¹´åº¦æ‚£è€…åˆ†å¸ƒï¼ˆå’Œåœ–äºŒä¸€æ¨£çš„é‚è¼¯ï¼‰
        const patientYearMap = new Map();
        
        if (baseResults.encounters && baseResults.patients) {
            baseResults.encounters.forEach(encounter => {
                const patientRef = encounter.subject?.reference;
                if (!patientRef) return;
                
                const patientId = patientRef.split('/').pop();
                const encDate = encounter.period?.start || encounter.period?.end;
                if (!encDate) return;
                
                const year = new Date(encDate).getFullYear();
                if (!patientYearMap.has(patientId)) {
                    patientYearMap.set(patientId, new Set());
                }
                patientYearMap.get(patientId).add(year);
            });
        }
        
        // æ”¶é›†æ‰€æœ‰å¹´ä»½ä¸¦çµ±è¨ˆæ‚£è€…æ•¸
        const allYearsMap = new Map(); // year -> patient count
        
        patientYearMap.forEach((years) => {
            years.forEach(year => {
                if (!allYearsMap.has(year)) {
                    allYearsMap.set(year, 0);
                }
                allYearsMap.set(year, allYearsMap.get(year) + 1);
            });
        });
        
        // æŒ‰å¹´ä»½æ’åº
        const sortedYears = Array.from(allYearsMap.keys()).sort((a, b) => a - b);
        
        console.log(`\nâœ… ${diseaseNames[disease]} å¹´åº¦æ‚£è€…åˆ†å¸ƒ:`);
        console.log(`======================================`);
        console.log(`ğŸ“Š ç¸½æ‚£è€…æ•¸: ${patientsCount} ä½`);
        console.log(`ğŸ“… ç¸½å°±è¨ºè¨˜éŒ„: ${encountersCount} ç­†`);
        console.log(`ğŸ“† å¯¦éš›è³‡æ–™å¹´ä»½ç¯„åœ: ${sortedYears[0] || 'ç„¡'} ~ ${sortedYears[sortedYears.length - 1] || 'ç„¡'}`);
        console.log(`ğŸ“ˆ å¹´åº¦åˆ†å¸ƒ:`);
        sortedYears.forEach(year => {
            console.log(`   ${year}å¹´: ${allYearsMap.get(year)} äºº`);
        });
        console.log(`ğŸŒ è³‡æ–™ä¾†æº: ${window.fhirConnection.getServerUrl()}`);
        console.log(`======================================\n`);
        
        // å–å¾—æœ€è¿‘å…©å€‹å¹´ä»½çš„è³‡æ–™ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        let year1 = 2024, year2 = 2025; // é è¨­å€¼
        let year1Count = 0, year2Count = 0;
        
        if (sortedYears.length >= 2) {
            // ä½¿ç”¨å¯¦éš›è³‡æ–™ä¸­çš„æœ€è¿‘å…©å¹´
            year2 = sortedYears[sortedYears.length - 1]; // æœ€æ–°å¹´ä»½
            year1 = sortedYears[sortedYears.length - 2]; // æ¬¡æ–°å¹´ä»½
            year2Count = allYearsMap.get(year2) || 0;
            year1Count = allYearsMap.get(year1) || 0;
        } else if (sortedYears.length === 1) {
            // åªæœ‰ä¸€å€‹å¹´ä»½
            year1 = sortedYears[0];
            year1Count = allYearsMap.get(year1) || 0;
            year2 = year1 + 1; // ä¸‹ä¸€å¹´ï¼ˆå¯èƒ½æ²’è³‡æ–™ï¼‰
            year2Count = 0;
        }
        
        console.log(`\nğŸš€ æº–å‚™èª¿ç”¨ updateOverviewCardDirect:`);
        console.log(`   - disease: ${disease}`);
        console.log(`   - encountersCount: ${encountersCount}`);
        console.log(`   - todayNewCases: ${todayNewCases}`);
        console.log(`   - ${year1}å¹´æ‚£è€…: ${year1Count}`);
        console.log(`   - ${year2}å¹´æ‚£è€…: ${year2Count}`);
        
        updateOverviewCardDirect(disease, encountersCount, todayNewCases, year1Count, year2Count, year1, year2);
        
        // å„²å­˜çµæœï¼ˆåŒ…å«å¯¦éš›å¹´ä»½è³‡è¨Šï¼‰
        currentResults[disease] = {
            ...baseResults,
            totalCases: encountersCount,
            newCasesToday: todayNewCases,
            patientsCount: patientsCount,
            actualYear1: year1,
            actualYear2: year2,
            yearDistribution: yearDistribution
        };
        
        // æ›´æ–°æ—¥æœŸç¯„åœé¡¯ç¤º
        updateDateRange(currentResults[disease]);
    } catch (error) {
        console.error(`âŒ ${diseaseNames[disease]} è™•ç†å¤±æ•—:`, error);
    }
    
    console.log('\n========================================');
    console.log('ğŸ COVID-19 æŸ¥è©¢å®Œæˆï¼');
    console.log('========================================\n');
}

// æ¸¬è©¦ FHIR ä¼ºæœå™¨è³‡æ–™
async function testFHIRData() {
    const testResults = document.getElementById('testResults');
    if (!testResults) return;
    
    testResults.innerHTML = '<p style="color: #2563eb;"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ¸¬è©¦...</p>';
    
    const conn = window.fhirConnection || fhirConnection;
    
    if (!conn || !conn.isServerConnected()) {
        testResults.innerHTML = '<p style="color: #ef4444;">è«‹å…ˆè¨­å®š FHIR ä¼ºæœå™¨é€£ç·š</p>';
        return;
    }
    
    const results = {
        patient: 0,
        encounter: 0,
        condition: 0,
        observation: 0
    };
    
    try {
        // æ¸¬è©¦å„ç¨®è³‡æº
        const tests = [
            { name: 'Patient', key: 'patient' },
            { name: 'Encounter', key: 'encounter' },
            { name: 'Condition', key: 'condition' },
            { name: 'Observation', key: 'observation' }
        ];
        
        for (const test of tests) {
            try {
                const data = await conn.query(test.name, { _count: 10 });
                if (data.entry && data.entry.length > 0) {
                    results[test.key] = data.entry.length;
                } else if (data.total !== undefined) {
                    results[test.key] = data.total;
                }
                console.log(`${test.name}: ${results[test.key]} ç­†`);
            } catch (error) {
                console.error(`${test.name} æŸ¥è©¢å¤±æ•—:`, error);
            }
        }
        
        // é¡¯ç¤ºçµæœ
        const hasData = Object.values(results).some(v => v > 0);
        
        if (hasData) {
            testResults.innerHTML = `
                <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; color: #065f46;">
                    <p style="font-weight: 600; margin-bottom: 0.5rem;">âœ“ ä¼ºæœå™¨è³‡æ–™å¯ç”¨</p>
                    <ul style="margin: 0; padding-left: 1.5rem;">
                        <li>æ‚£è€… (Patient): ${results.patient} ç­†</li>
                        <li>å°±è¨ºè¨˜éŒ„ (Encounter): ${results.encounter} ç­†</li>
                        <li>è¨ºæ–· (Condition): ${results.condition} ç­†</li>
                        <li>æª¢é©— (Observation): ${results.observation} ç­†</li>
                    </ul>
                </div>
            `;
        } else {
            testResults.innerHTML = `
                <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; color: #92400e;">
                    <p style="font-weight: 600; margin-bottom: 0.5rem;">âš  ä¼ºæœå™¨æ²’æœ‰è³‡æ–™</p>
                    <p style="margin: 0; font-size: 0.9rem;">æ­¤ FHIR ä¼ºæœå™¨ç›®å‰æ²’æœ‰å¯ç”¨çš„é†«ç™‚è³‡æ–™ã€‚å»ºè­°åˆ‡æ›åˆ°å…¶ä»–æ¸¬è©¦ä¼ºæœå™¨ï¼ˆå¦‚ HAPI FHIRï¼‰ã€‚</p>
                </div>
            `;
        }
        
    } catch (error) {
        testResults.innerHTML = `
            <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; color: #991b1b;">
                <p style="font-weight: 600;">âœ— æ¸¬è©¦å¤±æ•—</p>
                <p style="margin: 0; font-size: 0.9rem;">${error.message}</p>
            </div>
        `;
    }
}

// ç¦ç”¨æ‰€æœ‰åŸ·è¡ŒæŒ‰éˆ•
function disableAllButtons() {
    const buttons = document.querySelectorAll('.btn-execute');
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-lock"></i> éœ€è¦é€£ç·š';
    });
}

// å•Ÿç”¨æ‰€æœ‰åŸ·è¡ŒæŒ‰éˆ•
function enableAllButtons() {
    const buttons = document.querySelectorAll('.btn-execute');
    buttons.forEach(btn => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> åŸ·è¡ŒæŸ¥è©¢';
    });
}

// åŸ·è¡Œ CQL æŸ¥è©¢
// å°‡ executeCQL å®šç¾©ç‚ºå…¨åŸŸå‡½æ•¸
window.executeCQL = async function(diseaseType) {
    console.log('========================================');
    console.log(`ğŸš€ executeCQL è¢«èª¿ç”¨! ç–¾ç—…é¡å‹: ${diseaseType}`);
    console.log('========================================');
    alert('executeCQL è¢«èª¿ç”¨: ' + diseaseType);
    
    // ä½¿ç”¨ window.fhirConnection ç¢ºä¿å¼•ç”¨æ­£ç¢º
    const conn = window.fhirConnection || fhirConnection;
    
    // æª¢æŸ¥é€£ç·š
    if (!conn || !conn.isServerConnected()) {
        showNotification('è«‹å…ˆåœ¨é¦–é è¨­å®š FHIR ä¼ºæœå™¨é€£ç·š', 'error');
        window.location.href = 'index.html';
        return;
    }
    
    // ç¢ºä¿ CQL Engine å·²åˆå§‹åŒ–
    if (!window.cqlEngine) {
        window.cqlEngine = new CQLEngine(conn);
    }
    
    // ID æ˜ å°„
    const btnMap = {
        'covid19': 'btnCovid',
        'influenza': 'btnInfluenza',
        'conjunctivitis': 'btnConjunctivitis',
        'enterovirus': 'btnEnterovirus',
        'diarrhea': 'btnDiarrhea'
    };
    
    const statusMap = {
        'covid19': 'statusCovid',
        'influenza': 'statusInfluenza',
        'conjunctivitis': 'statusConjunctivitis',
        'enterovirus': 'statusEnterovirus',
        'diarrhea': 'statusDiarrhea'
    };
    
    const btn = document.getElementById(btnMap[diseaseType]);
    const status = document.getElementById(statusMap[diseaseType]);
    
    if (!btn) {
        console.error('æ‰¾ä¸åˆ°æŒ‰éˆ•å…ƒç´ ');
        return;
    }
    
    // è¨­å®šæŒ‰éˆ•ç‚ºè¼‰å…¥ç‹€æ…‹
    btn.disabled = true;
    btn.classList.add('loading');
    
    // é€²åº¦è¿½è¹¤
    let progress = 0;
    let progressInterval = null;
    
    progressInterval = setInterval(() => {
        progress += 5;
        if (progress <= 90) {
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> æŸ¥è©¢ä¸­ ${progress}%`;
        }
    }, 200);
    
    // ä¸é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹è¨Šæ¯
    
    try {
        // åŸ·è¡Œ CQL æŸ¥è©¢
        const currentServer = localStorage.getItem('fhirServer');
        console.log(`ğŸ“¡ å¾ ${currentServer} åŸ·è¡ŒæŸ¥è©¢...`);
        
        const results = await window.cqlEngine.executeCQL(diseaseType);
        
        // æ¸…é™¤é€²åº¦æ›´æ–°
        if (progressInterval) {
            clearInterval(progressInterval);
        }
        btn.innerHTML = '<i class="fas fa-check"></i> å®Œæˆ 100%';
        
        console.log('ğŸ“Š CQL åŸ·è¡Œçµæœ:', results);
        console.log(`ğŸ“Š æ‚£è€…æ•¸: ${results.patients?.length || 0} ä½`);
        console.log(`ğŸ“Š å°±è¨ºè¨˜éŒ„: ${results.encounters?.length || 0} ç­†`);
        console.log(`ğŸ“Š è³‡æ–™ä¾†æº: ${currentServer}`);
        
        // å„²å­˜çµæœ
        currentResults[diseaseType] = results;
        
        // è¨ˆç®—è©²ç–¾ç—…çš„å”¯ä¸€æ‚£è€…æ•¸ - å¾Encountersæˆ–Conditionsä¸­æå–
        let uniquePatients = new Set();
        
        // å„ªå…ˆå¾Conditionsæå–æ‚£è€…
        if (results.conditions && results.conditions.length > 0) {
            results.conditions.forEach(condition => {
                const patientRef = condition.subject?.reference;
                if (patientRef) {
                    const patientId = patientRef.split('/').pop();
                    uniquePatients.add(patientId);
                }
            });
            console.log(`ğŸ“Š å¾ ${results.conditions.length} å€‹è¨ºæ–·è¨˜éŒ„ä¸­æ‰¾åˆ° ${uniquePatients.size} ä½å”¯ä¸€æ‚£è€…`);
        }
        
        // å¦‚æœæ²’æœ‰Conditions,å¾Encountersæå–
        if (uniquePatients.size === 0 && results.encounters && results.encounters.length > 0) {
            results.encounters.forEach(encounter => {
                const patientRef = encounter.subject?.reference;
                if (patientRef) {
                    const patientId = patientRef.split('/').pop();
                    uniquePatients.add(patientId);
                }
            });
            console.log(`ğŸ“Š å¾ ${results.encounters.length} å€‹å°±è¨ºè¨˜éŒ„ä¸­æ‰¾åˆ° ${uniquePatients.size} ä½å”¯ä¸€æ‚£è€…`);
        }
        
        const totalPatients = uniquePatients.size;
        console.log(`ğŸ¯ è©²ç–¾ç—…çš„ç¸½æ‚£è€…æ•¸: ${totalPatients} ä½`);
        
        updateCardTotal(diseaseType, totalPatients);
        
        // ä¸é¡¯ç¤ºçµæœå€åŸŸï¼ˆå·²åˆªé™¤ï¼‰
        
        showNotification(`${getDiseaseDisplayName(diseaseType)} æŸ¥è©¢å®Œæˆ - ${actualCount} ç­†è³‡æ–™`, 'success');
        
        // æŸ¥è©¢å®Œæˆå¾Œè‡ªå‹•é¡¯ç¤ºè©³ç´°å ±å‘Š
        console.log('ğŸ”” æº–å‚™åœ¨ 500ms å¾Œèª¿ç”¨ showDetailReport');
        console.log('ğŸ”” diseaseType:', diseaseType);
        console.log('ğŸ”” showDetailReport å‡½æ•¸å­˜åœ¨å—?', typeof showDetailReport);
        setTimeout(() => {
            console.log('ğŸ””ğŸ””ğŸ”” ç¾åœ¨èª¿ç”¨ showDetailReport!');
            alert('å³å°‡èª¿ç”¨ showDetailReport: ' + diseaseType);
            showDetailReport(diseaseType);
        }, 500);
        
    } catch (error) {
        console.error('CQL åŸ·è¡ŒéŒ¯èª¤:', error);
        
        // æ¸…é™¤é€²åº¦æ›´æ–°
        if (progressInterval) {
            clearInterval(progressInterval);
        }
        
        // ä¸é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        
        console.error('æŸ¥è©¢å¤±æ•—ä½†ä¸é¡¯ç¤ºçµ¦ç”¨æˆ¶:', error.message);
    } finally {
        // æ¢å¾©æŒ‰éˆ•
        btn.disabled = false;
        btn.classList.remove('loading');
        
        // å»¶é² 1 ç§’å¾Œæ¢å¾©æŒ‰éˆ•æ–‡å­—
        setTimeout(() => {
            if (btn) {
                btn.innerHTML = '<i class="fas fa-play"></i> åŸ·è¡ŒæŸ¥è©¢';
            }
        }, 1000);
    }
};

// æ›´æ–°ç¸½è¦½å¡ç‰‡
function updateOverviewCard(diseaseType, results) {
    console.log('\n========== updateOverviewCard é–‹å§‹ ==========');
    console.log('ç–¾ç—…é¡å‹:', diseaseType);
    console.log('æ”¶åˆ°çš„ results:', results);
    console.log('results.totalCases:', results?.totalCases);
    
    // ID æ˜ å°„ - ä¿®æ­£åç¨±å°æ‡‰
    const idMap = {
        'covid19': 'covid',
        'influenza': 'flu',
        'dengue': 'dengue',
        'enterovirus': 'entero',
        'diarrhea': 'diarrhea'
    };
    
    const cardId = idMap[diseaseType] || diseaseType;
    const totalId = `${cardId}Total`;
    const trendId = `${cardId}Trend`;
    
    const totalElement = document.getElementById(totalId);
    const trendElement = document.getElementById(trendId);
    
    console.log(`æ›´æ–°å¡ç‰‡: ${diseaseType} â†’ ${cardId}`, {
        totalId,
        trendId,
        totalCases: results.totalCases,
        newCasesToday: results.newCasesToday,
        totalElement: !!totalElement,
        trendElement: !!trendElement
    });
    
    if (totalElement) {
        // æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™
        const caseCount = results.totalCases || 0;
        
        if (caseCount === 0 && results.queriedButEmpty) {
            // å¦‚æœæŸ¥è©¢éä½†æ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤º"è³‡æ–™åº«ç„¡è³‡æ–™"
            totalElement.innerHTML = '<div class="no-data-message" style="font-size: 0.9rem; color: #94a3b8;"><i class="fas fa-database"></i> è³‡æ–™åº«ç„¡è³‡æ–™</div>';
            console.log(`âœ“ å·²é¡¯ç¤ºç„¡è³‡æ–™è¨Šæ¯ ${totalId}`);
        } else {
            // æœ‰è³‡æ–™æ™‚æ­£å¸¸é¡¯ç¤º
            totalElement.textContent = formatNumber(caseCount);
            console.log(`âœ“ å·²æ›´æ–° ${totalId} = ${caseCount}`);
            
            // å¦‚æœæœ‰æ•¸æ“šæ‰åšå‹•ç•«
            if (caseCount > 0) {
                setTimeout(() => animateValue(totalElement, 0, caseCount, 1000), 100);
            }
        }
    } else {
        console.warn(`âœ— æ‰¾ä¸åˆ°å…ƒç´ : ${totalId}`);
    }
    
    if (trendElement) {
        const trendSpan = trendElement.querySelector('span');
        if (trendSpan) {
            const newCases = results.newCasesToday || 0;
            trendSpan.textContent = newCases;
            console.log(`âœ“ å·²æ›´æ–° ${trendId} span = ${newCases}`);
        }
        
        // æ ¹æ“šè¶¨å‹¢æ›´æ–°åœ–æ¨™
        const trendIcon = trendElement.querySelector('i');
        if (trendIcon && results.newCasesToday > 0) {
            trendIcon.className = 'fas fa-arrow-up';
            trendElement.style.color = '#10b981';
        } else if (trendIcon) {
            trendIcon.className = 'fas fa-minus';
            trendElement.style.color = '#64748b';
        }
    } else {
        console.warn(`âœ— æ‰¾ä¸åˆ°å…ƒç´ : ${trendId}`);
    }
    
    console.log('========== updateOverviewCard çµæŸ ==========\n');
}

// ç›´æ¥æ›´æ–°å¡ç‰‡ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
function updateOverviewCardDirect(diseaseType, totalCases, newCases, patientsYear1 = 0, patientsYear2 = 0, year1 = 2024, year2 = 2025) {
    console.log(`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    console.log(`ğŸ¯ updateOverviewCardDirect è¢«èª¿ç”¨ï¼`);
    console.log(`   ç–¾ç—…é¡å‹: ${diseaseType}`);
    console.log(`   ç¸½æ•¸: ${totalCases}`);
    console.log(`   æ–°å¢: ${newCases}`);
    console.log(`   ${year1}å¹´æ‚£è€…: ${patientsYear1}`);
    console.log(`   ${year2}å¹´æ‚£è€…: ${patientsYear2}`);
    console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    
    const idMap = {
        'covid19': 'covid',
        'influenza': 'flu',
        'dengue': 'dengue',
        'enterovirus': 'entero',
        'diarrhea': 'diarrhea'
    };
    
    const cardId = idMap[diseaseType] || diseaseType;
    const year1Id = `${cardId}2024`;
    const year2Id = `${cardId}2025`;
    const year1LabelId = `${cardId}Year1Label`;
    const year2LabelId = `${cardId}Year2Label`;
    const trendId = `${cardId}Trend`;
    
    console.log(`ğŸ“ ç›®æ¨™å…ƒç´  ID:`);
    console.log(`   - ${year1}å¹´å…ƒç´  ID: ${year1Id}`);
    console.log(`   - ${year2}å¹´å…ƒç´  ID: ${year2Id}`);
    
    // æ›´æ–°å¹´ä»½æ¨™ç±¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const year1Label = document.querySelector(`#${year1Id}`);
    const year2Label = document.querySelector(`#${year2Id}`);
    
    if (year1Label && year1Label.parentElement) {
        const labelElement = year1Label.parentElement.querySelector('.year-label');
        if (labelElement) {
            labelElement.textContent = `${year1}å¹´`;
        }
    }
    
    if (year2Label && year2Label.parentElement) {
        const labelElement = year2Label.parentElement.querySelector('.year-label');
        if (labelElement) {
            labelElement.textContent = `${year2}å¹´`;
        }
    }
    
    // æ›´æ–°ç¬¬ä¸€å¹´äººæ•¸
    const year1Element = document.getElementById(year1Id);
    console.log(`ğŸ” æŸ¥æ‰¾å…ƒç´ : ${year1Id}`);
    console.log(`   å…ƒç´ å­˜åœ¨: ${year1Element !== null}`);
    if (year1Element) {
        const formattedValue = formatNumber(patientsYear1);
        console.log(`   åŸå§‹å€¼: ${patientsYear1}`);
        console.log(`   æ ¼å¼åŒ–å€¼: ${formattedValue}`);
        console.log(`   ç•¶å‰å…§å®¹: "${year1Element.textContent}"`);
        year1Element.textContent = formattedValue;
        console.log(`   æ›´æ–°å¾Œå…§å®¹: "${year1Element.textContent}"`);
        console.log(`âœ… æˆåŠŸæ›´æ–° ${year1Id} = ${patientsYear1}`);
    } else {
        console.error(`âŒ æ‰¾ä¸åˆ°å…ƒç´ : ${year1Id}`);
    }
    
    // æ›´æ–°ç¬¬äºŒå¹´äººæ•¸
    const year2Element = document.getElementById(year2Id);
    console.log(`ğŸ” æŸ¥æ‰¾å…ƒç´ : ${year2Id}`);
    console.log(`   å…ƒç´ å­˜åœ¨: ${year2Element !== null}`);
    if (year2Element) {
        const formattedValue = formatNumber(patientsYear2);
        console.log(`   åŸå§‹å€¼: ${patientsYear2}`);
        console.log(`   æ ¼å¼åŒ–å€¼: ${formattedValue}`);
        console.log(`   ç•¶å‰å…§å®¹: "${year2Element.textContent}"`);
        year2Element.textContent = formattedValue;
        console.log(`   æ›´æ–°å¾Œå…§å®¹: "${year2Element.textContent}"`);
        console.log(`âœ… æˆåŠŸæ›´æ–° ${year2Id} = ${patientsYear2}`);
    } else {
        console.error(`âŒ æ‰¾ä¸åˆ°å…ƒç´ : ${year2Id}`);
    }
    
    // æ›´æ–°æ–°å¢æ•¸
    const trendElement = document.getElementById(trendId);
    if (trendElement) {
        const trendSpan = trendElement.querySelector('span');
        if (trendSpan) {
            trendSpan.textContent = newCases;
            console.log(`âœ… æˆåŠŸæ›´æ–° ${trendId} span = ${newCases}`);
        }
    } else {
        console.error(`âŒ æ‰¾ä¸åˆ°å…ƒç´ : ${trendId}`);
    }
    
    // æ›´æ–°æ—¥æœŸç¯„åœ
    const dateRangeId = `${cardId}DateRange`;
    const dateRangeElement = document.getElementById(dateRangeId);
    if (dateRangeElement) {
        const dateRange = calculateDateRange();
        dateRangeElement.textContent = dateRange;
        console.log(`âœ… æˆåŠŸæ›´æ–° ${dateRangeId} = ${dateRange}`);
    } else {
        console.error(`âŒ æ‰¾ä¸åˆ°å…ƒç´ : ${dateRangeId}`);
    }
}

// è¨ˆç®—æ—¥æœŸç¯„åœï¼ˆ2å¹´å›æº¯åˆ°ä»Šå¤©ï¼‰
function calculateDateRange() {
    // ä¸å†é™åˆ¶æ—¥æœŸï¼Œé¡¯ç¤ºå…¨éƒ¨è³‡æ–™
    return 'è³‡æ–™ç¯„åœ: å…¨éƒ¨è³‡æ–™';
}

// æ›´æ–°å¡ç‰‡ç¸½äººæ•¸ï¼ˆæ–°ç‰ˆç°¡åŒ–å‡½æ•¸ï¼‰
function updateCardTotal(diseaseType, totalCount) {
    const idMap = {
        'covid19': 'covid',
        'influenza': 'flu',
        'conjunctivitis': 'conjunctivitis',
        'enterovirus': 'entero',
        'diarrhea': 'diarrhea'
    };
    
    const cardId = idMap[diseaseType] || diseaseType;
    const totalId = `${cardId}Total`;
    const totalElement = document.getElementById(totalId);
    
    if (totalElement) {
        if (totalCount === 0 || totalCount === null || totalCount === undefined) {
            totalElement.textContent = 'è³‡æ–™åº«ç„¡è³‡æ–™';
            totalElement.classList.add('no-data');
        } else {
            totalElement.textContent = formatNumber(totalCount);
            totalElement.classList.remove('no-data');
        }
        console.log(`âœ… æ›´æ–° ${totalId} = ${totalCount || 'è³‡æ–™åº«ç„¡è³‡æ–™'}`);
    } else {
        console.error(`âŒ æ‰¾ä¸åˆ°å…ƒç´ : ${totalId}`);
    }
}

// æ›´æ–°çµ±è¨ˆæ‘˜è¦ï¼ˆé¡¯ç¤ºçœŸå¯¦ FHIR æŸ¥è©¢çµæœï¼‰
function updateStatsSummary(results) {
    console.log('ğŸ“Š æ›´æ–°çµ±è¨ˆæ‘˜è¦ï¼ˆçœŸå¯¦è³‡æ–™ï¼‰:', results);
    
    const summaryPatients = document.getElementById('summaryPatients');
    const summaryEncounters = document.getElementById('summaryEncounters');
    const summaryConditions = document.getElementById('summaryConditions');
    const summaryObservations = document.getElementById('summaryObservations');
    
    // ä½¿ç”¨çœŸå¯¦å¾ FHIR æŸ¥è©¢åˆ°çš„æ•¸é‡
    const patientsCount = results.patients?.length || 0;
    const encountersCount = results.encounters?.length || 0;
    const conditionsCount = results.conditions?.length || 0;
    const observationsCount = results.observations?.length || 0;
    
    console.log(`  âœ“ çœŸå¯¦æ•¸æ“š: P=${patientsCount}, E=${encountersCount}, C=${conditionsCount}, O=${observationsCount}`);
    
    if (summaryPatients) {
        summaryPatients.textContent = formatNumber(patientsCount);
    }
    if (summaryEncounters) {
        summaryEncounters.textContent = formatNumber(encountersCount);
    }
    if (summaryConditions) {
        summaryConditions.textContent = formatNumber(conditionsCount);
    }
    if (summaryObservations) {
        summaryObservations.textContent = formatNumber(observationsCount);
    }
}

function animateValue(element, start, end, duration) {
    if (end === 0) {
        element.textContent = '0';
        return;
    }
    
    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
        current += increment;
        if (current >= end) {
            element.textContent = formatNumber(end);
            clearInterval(timer);
        } else {
            element.textContent = formatNumber(Math.floor(current));
        }
    }, 16);
}

// åˆå§‹åŒ–åœ–è¡¨
function initCharts() {
    const trendCtx = document.getElementById('trendChart');
    const sourceCtx = document.getElementById('sourceChart');
    const ageCtx = document.getElementById('ageChart');
    
    if (trendCtx) {
        trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'ç—…ä¾‹æ•¸',
                    data: [],
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
    
    if (sourceCtx) {
        sourceChart = new Chart(sourceCtx, {
            type: 'doughnut',
            data: {
                labels: ['æ€¥è¨º', 'ä½é™¢', 'é–€è¨º'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#ef4444', '#f59e0b', '#10b981']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    if (ageCtx) {
        ageChart = new Chart(ageCtx, {
            type: 'bar',
            data: {
                labels: ['0-10', '11-20', '21-40', '41-60', '60+'],
                datasets: [{
                    label: 'ç—…ä¾‹æ•¸',
                    data: [0, 0, 0, 0, 0],
                    backgroundColor: '#8b5cf6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
}

// æ›´æ–°åœ–è¡¨
function updateCharts(results) {
    // æ›´æ–°è¶¨å‹¢åœ–
    if (trendChart && results.trendData) {
        trendChart.data.labels = results.trendData.map(d => d.date);
        trendChart.data.datasets[0].data = results.trendData.map(d => d.cases);
        trendChart.update();
    }
    
    // æ›´æ–°ä¾†æºåœ–
    if (sourceChart && results.summary) {
        sourceChart.data.datasets[0].data = [
            results.summary.emergency,
            results.summary.inpatient,
            results.summary.outpatient
        ];
        sourceChart.update();
    }
    
    // æ›´æ–°å¹´é½¡åœ–
    if (ageChart && results.ageDistribution) {
        const ageData = Object.values(results.ageDistribution);
        ageChart.data.datasets[0].data = ageData;
        ageChart.update();
    }
}

// æ›´æ–°è³‡æ–™è¡¨
function updateResultsTable(diseaseType, results) {
    const tbody = document.getElementById('resultsTableBody');
    tbody.innerHTML = '';
    
    console.log('æ›´æ–°è³‡æ–™è¡¨:', {
        diseaseType,
        encountersCount: results.encounters?.length,
        conditionsCount: results.conditions?.length
    });
    
    // å„ªå…ˆé¡¯ç¤ºå°±è¨ºè¨˜éŒ„
    if (results.encounters && results.encounters.length > 0) {
        // é¡¯ç¤ºå‰50ç­†
        results.encounters.slice(0, 50).forEach((encounter, index) => {
            const row = tbody.insertRow();
            
            // å˜—è©¦æ‰¾å°æ‡‰çš„è¨ºæ–·
            let diagnosisCode = '--';
            let diagnosisDesc = '--';
            
            if (results.conditions && results.conditions.length > 0) {
                const condition = results.conditions[index % results.conditions.length];
                if (condition.code?.coding?.[0]) {
                    diagnosisCode = condition.code.coding[0].code || '--';
                    diagnosisDesc = condition.code.coding[0].display || condition.code.text || '--';
                }
            }
            
            row.innerHTML = `
                <td><strong>${getDiseaseDisplayName(diseaseType)}</strong></td>
                <td>${encounter.date}</td>
                <td><span class="badge badge-${encounter.type}">${getEncounterTypeDisplay(encounter.type)}</span></td>
                <td><code>${diagnosisCode}</code></td>
                <td>${diagnosisDesc}</td>
                <td>${results.observations?.length > 0 ? 'æœ‰æª¢é©—' : '--'}</td>
                <td><span class="badge ${getStatusBadgeClass(encounter.status)}">${encounter.status}</span></td>
            `;
        });
        
        console.log(`âœ“ å·²é¡¯ç¤º ${Math.min(50, results.encounters.length)} ç­†å°±è¨ºè¨˜éŒ„`);
    } 
    else if (results.conditions && results.conditions.length > 0) {
        // å¦‚æœæ²’æœ‰å°±è¨ºè¨˜éŒ„ï¼Œé¡¯ç¤ºè¨ºæ–·è¨˜éŒ„
        results.conditions.slice(0, 50).forEach(condition => {
            const row = tbody.insertRow();
            
            const diagnosisCode = condition.code?.coding?.[0]?.code || '--';
            const diagnosisDesc = condition.code?.coding?.[0]?.display || condition.code?.text || '--';
            const recordedDate = condition.recordedDate?.split('T')[0] || condition.onsetDateTime?.split('T')[0] || '--';
            
            row.innerHTML = `
                <td><strong>${getDiseaseDisplayName(diseaseType)}</strong></td>
                <td>${recordedDate}</td>
                <td><span class="badge badge-other">è¨ºæ–·è¨˜éŒ„</span></td>
                <td><code>${diagnosisCode}</code></td>
                <td>${diagnosisDesc}</td>
                <td>--</td>
                <td><span class="badge ${getStatusBadgeClass(condition.clinicalStatus?.coding?.[0]?.code)}">${condition.clinicalStatus?.coding?.[0]?.code || 'active'}</span></td>
            `;
        });
        
        console.log(`âœ“ å·²é¡¯ç¤º ${Math.min(50, results.conditions.length)} ç­†è¨ºæ–·è¨˜éŒ„`);
    }
    else {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center" style="padding: 2rem; color: #64748b;">
                    <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <br>
                    æ­¤ FHIR ä¼ºæœå™¨ç›®å‰æ²’æœ‰ç›¸é—œç—…ä¾‹è³‡æ–™
                    <br>
                    <small>æ‚¨å¯ä»¥å˜—è©¦ä½¿ç”¨å…¶ä»– FHIR ä¼ºæœå™¨æˆ–æŸ¥è©¢ä¸åŒç–¾ç—…é¡å‹</small>
                </td>
            </tr>
        `;
        console.log('âš  æ²’æœ‰å¯é¡¯ç¤ºçš„è³‡æ–™');
    }
}

// å·¥å…·å‡½æ•¸
function getDiseaseDisplayName(type) {
    const names = {
        covid19: 'COVID-19',
        influenza: 'æµæ„Ÿ',
        conjunctivitis: 'æ€¥æ€§çµè†œç‚',
        enterovirus: 'è…¸ç—…æ¯’',
        diarrhea: 'è…¹ç€‰'
    };
    return names[type] || type;
}

function getEncounterTypeDisplay(type) {
    const types = {
        emergency: 'æ€¥è¨º',
        inpatient: 'ä½é™¢',
        outpatient: 'é–€è¨º',
        other: 'å…¶ä»–'
    };
    return types[type] || type;
}

function getStatusBadgeClass(status) {
    if (status === 'finished' || status === 'completed') return 'badge-success';
    if (status === 'in-progress') return 'badge-warning';
    return 'badge-secondary';
}

// æŸ¥çœ‹ CQL ç¨‹å¼ç¢¼
function viewCQL(diseaseType) {
    const cqlCode = cqlEngine.getCQLSource(diseaseType);
    
    if (!cqlCode) {
        showNotification('ç„¡æ³•è¼‰å…¥ CQL ç¨‹å¼ç¢¼', 'error');
        return;
    }
    
    document.getElementById('cqlCode').textContent = cqlCode;
    document.getElementById('cqlModal').classList.add('show');
}

// é—œé–‰æ¨¡æ…‹æ¡†
function closeCQLModal() {
    document.getElementById('cqlModal').classList.remove('show');
}

// è¤‡è£½ CQL ç¨‹å¼ç¢¼
function copyCQL() {
    const cqlCode = document.getElementById('cqlCode').textContent;
    navigator.clipboard.writeText(cqlCode).then(() => {
        showNotification('CQL ç¨‹å¼ç¢¼å·²è¤‡è£½', 'success');
    }).catch(() => {
        showNotification('è¤‡è£½å¤±æ•—', 'error');
    });
}

// é‡æ–°æ•´ç†æ‰€æœ‰è³‡æ–™
async function refreshAllData() {
    showNotification('é–‹å§‹é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š...', 'info');
    
    const diseaseTypes = ['covid19', 'influenza', 'conjunctivitis', 'enterovirus', 'diarrhea'];
    
    for (const type of diseaseTypes) {
        if (currentResults[type]) {
            await executeCQL(type);
            // å»¶é²ä»¥é¿å…éåº¦è«‹æ±‚
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
    
    showNotification('æ‰€æœ‰æ•¸æ“šå·²æ›´æ–°', 'success');
}

// åŒ¯å‡ºæ‰€æœ‰è³‡æ–™
function exportAllData() {
    if (Object.keys(currentResults).length === 0) {
        showNotification('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™', 'warning');
        return;
    }
    
    const exportData = {
        exportDate: new Date().toISOString(),
        fhirServer: fhirConnection.getServerUrl(),
        results: currentResults
    };
    
    exportToJSON(exportData, `ç–¾ç®¡å„€è¡¨æ¿_${new Date().toISOString().split('T')[0]}.json`);
    showNotification('è³‡æ–™å·²åŒ¯å‡º', 'success');
}

// åŒ¯å‡ºè³‡æ–™è¡¨
function exportTableData() {
    const table = document.getElementById('resultsTable');
    const rows = table.querySelectorAll('tbody tr');
    
    if (rows.length === 0 || rows[0].cells.length === 1) {
        showNotification('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™', 'warning');
        return;
    }
    
    const data = [];
    rows.forEach(row => {
        const cells = row.cells;
        data.push({
            ç–¾ç—…é¡å‹: cells[0].textContent,
            å°±è¨ºæ—¥æœŸ: cells[1].textContent,
            å°±è¨ºé¡å‹: cells[2].textContent,
            è¨ºæ–·ç¢¼: cells[3].textContent,
            è¨ºæ–·æè¿°: cells[4].textContent,
            æª¢é©—çµæœ: cells[5].textContent,
            ç‹€æ…‹: cells[6].textContent
        });
    });
    
    exportToCSV(data, `ç—…ä¾‹è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`);
    showNotification('è³‡æ–™è¡¨å·²åŒ¯å‡º', 'success');
}

// æœå°‹åŠŸèƒ½
document.getElementById('searchTable')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#resultsTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// ========== è©³ç´°æ•¸æ“šæ¨¡æ…‹æ¡† ==========
let currentDetailDisease = null;

function showDetailModal(diseaseType) {
    console.log(`é¡¯ç¤º ${diseaseType} çš„è©³ç´°æ•¸æ“š`);
    currentDetailDisease = diseaseType;
    
    const modal = document.getElementById('detailModal');
    const modalTitle = document.getElementById('modalTitle');
    
    const diseaseNames = {
        'covid19': 'COVID-19',
        'influenza': 'æµæ„Ÿ',
        'conjunctivitis': 'æ€¥æ€§çµè†œç‚',
        'enterovirus': 'è…¸ç—…æ¯’',
        'diarrhea': 'è…¹ç€‰ç¾¤èš'
    };
    
    const diseaseIcons = {
        'covid19': 'fa-virus',
        'influenza': 'fa-disease',
        'conjunctivitis': 'fa-eye',
        'enterovirus': 'fa-hand-dots',
        'diarrhea': 'fa-bacteria'
    };
    
    modalTitle.innerHTML = `<i class="fas ${diseaseIcons[diseaseType]}"></i> ${diseaseNames[diseaseType]} è©³ç´°æ•¸æ“š`;
    
    // å¾ currentResults å–å¾—è³‡æ–™
    const results = currentResults[diseaseType];
    
    if (results) {
        updateDetailModalData(results);
    } else {
        // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºé è¨­å€¼
        document.getElementById('detailTotal').textContent = '--';
        document.getElementById('detailNew').textContent = '--';
        document.getElementById('detailEncounters').textContent = '--';
        document.getElementById('detailConditions').textContent = '--';
        document.getElementById('detailPatients').textContent = '--';
        document.getElementById('detailObservations').textContent = '--';
    }
    
    modal.classList.add('show');
}

function updateDetailModalData(results) {
    console.log('æ›´æ–°æ¨¡æ…‹æ¡†è³‡æ–™:', results);
    
    const patientsCount = results.patients?.length || 0;
    const encountersCount = results.encounters?.length || 0;
    
    console.log(`ğŸ“Š æ¨¡æ…‹æ¡†é¡¯ç¤º: ${patientsCount} ä½æ‚£è€…ï¼Œ${encountersCount} ç­†å°±è¨º`);
    
    // é¡¯ç¤ºå¹´åº¦è³‡æ–™åˆ†å¸ƒï¼ˆæ”¹ç‚º: 2019ä»¥å‰ã€2020-2025å„å¹´ï¼‰
    updateYearPatientDistribution(results);
    
    // è¨ˆç®—å¹´é½¡åˆ†å¸ƒï¼ˆæŒ‰å¯¦éš›å¹´ä»½åˆ†çµ„ï¼‰
    updateAgeDistribution(results);
    
    // æ›´æ–°æ—¥æœŸç¯„åœï¼ˆåœ–ä¸‰ï¼šè³‡æ–™åº«æœ€æ—©+æœ€æ™šæ—¥æœŸï¼‰
    updateDateRange(results);
}

// æ–°å¢ï¼šæ›´æ–°å¹´åº¦æ‚£è€…åˆ†å¸ƒï¼ˆ2019ä»¥å‰ã€2020-2025ï¼‰
function updateYearPatientDistribution(results) {
    const container = document.getElementById('yearPatientDistributionChart');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!results.patients || results.patients.length === 0 || !results.encounters || results.encounters.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">ç„¡æ‚£è€…è³‡æ–™</div>';
        return;
    }
    
    // çµ±è¨ˆæ¯å€‹æ‚£è€…çš„å°±è¨ºå¹´ä»½
    const patientYearMap = new Map();
    results.encounters.forEach(encounter => {
        const patientRef = encounter.subject?.reference;
        if (!patientRef) return;
        
        const patientId = patientRef.split('/').pop();
        const encDate = encounter.period?.start || encounter.period?.end;
        if (!encDate) return;
        
        const year = new Date(encDate).getFullYear();
        if (!patientYearMap.has(patientId)) {
            patientYearMap.set(patientId, new Set());
        }
        patientYearMap.get(patientId).add(year);
    });
    
    // åˆ†çµ„çµ±è¨ˆï¼š2019ä»¥å‰ã€2020-2025å„å¹´
    const yearGroups = {
        'before2019': 0,
        '2020': 0,
        '2021': 0,
        '2022': 0,
        '2023': 0,
        '2024': 0,
        '2025': 0
    };
    
    patientYearMap.forEach((years, patientId) => {
        const yearArray = Array.from(years);
        const hasYear2020 = yearArray.includes(2020);
        const hasYear2021 = yearArray.includes(2021);
        const hasYear2022 = yearArray.includes(2022);
        const hasYear2023 = yearArray.includes(2023);
        const hasYear2024 = yearArray.includes(2024);
        const hasYear2025 = yearArray.includes(2025);
        const hasBefore2019 = yearArray.some(y => y < 2020);
        
        if (hasBefore2019) yearGroups['before2019']++;
        if (hasYear2020) yearGroups['2020']++;
        if (hasYear2021) yearGroups['2021']++;
        if (hasYear2022) yearGroups['2022']++;
        if (hasYear2023) yearGroups['2023']++;
        if (hasYear2024) yearGroups['2024']++;
        if (hasYear2025) yearGroups['2025']++;
    });
    
    const maxCount = Math.max(...Object.values(yearGroups));
    
    console.log('ğŸ“Š å¹´åº¦æ‚£è€…åˆ†å¸ƒ:', yearGroups);
    
    // é¡¯ç¤ºåˆ†çµ„ï¼ˆæŒ‰æŒ‡å®šé †åºï¼‰
    const displayOrder = ['before2019', '2020', '2021', '2022', '2023', '2024', '2025'];
    const labels = {
        'before2019': '2019ä»¥å‰',
        '2020': '2020å¹´',
        '2021': '2021å¹´',
        '2022': '2022å¹´',
        '2023': '2023å¹´',
        '2024': '2024å¹´',
        '2025': '2025å¹´'
    };
    
    displayOrder.forEach(key => {
        const count = yearGroups[key] || 0;
        const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
        
        const barItem = document.createElement('div');
        barItem.className = 'year-bar-item';
        barItem.innerHTML = `
            <span class="year-bar-label">${labels[key]}</span>
            <div class="year-bar-track">
                <div class="year-bar-fill" style="width: ${percentage}%"></div>
            </div>
            <span class="year-bar-count">${count} äºº</span>
        `;
        container.appendChild(barItem);
    });
}

// æ–°å¢ï¼šæ›´æ–°æ—¥æœŸç¯„åœï¼ˆè³‡æ–™åº«æœ€æ—©åˆ°æœ€æ™šçš„æ—¥æœŸï¼‰
function updateDateRange(results) {
    if (!results.encounters || results.encounters.length === 0) {
        return;
    }
    
    let earliestDate = null;
    let latestDate = null;
    
    results.encounters.forEach(encounter => {
        const encDate = encounter.period?.start || encounter.period?.end;
        if (encDate) {
            const date = new Date(encDate);
            if (!earliestDate || date < earliestDate) {
                earliestDate = date;
            }
            if (!latestDate || date > latestDate) {
                latestDate = date;
            }
        }
    });
    
    // ä½¿ç”¨å›ºå®šç¯„åœï¼š1900 åˆ°ä»Šå¤©
    const startDate = new Date(1900, 0, 1);
    const endDate = new Date();
    
    const formatDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}/${m}/${d}`;
    };
    
    const dateRangeText = `${formatDate(startDate)} ~ ${formatDate(endDate)}`;
    
    // æ›´æ–°æ‰€æœ‰å¡ç‰‡çš„æ—¥æœŸç¯„åœ
    const cardIds = ['covid', 'flu', 'conjunctivitis', 'entero', 'diarrhea'];
    cardIds.forEach(cardId => {
        const dateRangeElement = document.getElementById(`${cardId}DateRange`);
        if (dateRangeElement) {
            dateRangeElement.textContent = dateRangeText;
        }
    });
    
    console.log(`ğŸ“… è³‡æ–™æ—¥æœŸç¯„åœï¼ˆå›ºå®šï¼‰: ${dateRangeText}`);
}

function updateAgeDistribution(results) {
    if (!results.patients || results.patients.length === 0 || !results.encounters || results.encounters.length === 0) {
        console.log('âš ï¸ æ²’æœ‰æ‚£è€…æˆ–å°±è¨ºè³‡æ–™ï¼Œç„¡æ³•è¨ˆç®—å¹´é½¡åˆ†å¸ƒ');
        return;
    }
    
    // ä½¿ç”¨å¯¦éš›å¹´ä»½ï¼ˆå¾å„²å­˜çš„çµæœä¸­å–å¾—ï¼‰
    const year1 = results.actualYear1 || 2024;
    const year2 = results.actualYear2 || 2025;
    
    console.log(`ğŸ“Š è¨ˆç®—å¹´é½¡åˆ†å¸ƒï¼šä½¿ç”¨ ${year1}å¹´ å’Œ ${year2}å¹´`);
    
    // æ›´æ–°æ¨¡æ…‹æ¡†ä¸­çš„å¹´ä»½æ¨™ç±¤
    const year1Title = document.querySelector('#ageChart2024')?.parentElement?.querySelector('.year-chart-title');
    const year2Title = document.querySelector('#ageChart2025')?.parentElement?.querySelector('.year-chart-title');
    if (year1Title) year1Title.textContent = `${year1}å¹´`;
    if (year2Title) year2Title.textContent = `${year2}å¹´`;
    
    // å»ºç«‹æ‚£è€…IDèˆ‡é­é‡å¹´ä»½çš„å°æ‡‰
    const patientYearMap = new Map();
    results.encounters.forEach(encounter => {
        const patientRef = encounter.subject?.reference;
        if (!patientRef) return;
        
        const patientId = patientRef.split('/').pop();
        const encDate = encounter.period?.start || encounter.period?.end;
        if (!encDate) return;
        
        const year = new Date(encDate).getFullYear();
        if (year === year1 || year === year2) {
            if (!patientYearMap.has(patientId)) {
                patientYearMap.set(patientId, new Set());
            }
            patientYearMap.get(patientId).add(year);
        }
    });
    
    // è¨ˆç®—å¹´é½¡ä¸¦åˆ†çµ„
    const ageGroupsYear1 = {};
    const ageGroupsYear2 = {};
    
    results.patients.forEach(patient => {
        const patientId = patient.id;
        const years = patientYearMap.get(patientId);
        if (!years) return;
        
        const birthDate = patient.birthDate;
        if (!birthDate) return;
        
        // è¨ˆç®—ç•¶å‰å¹´é½¡
        const age = new Date().getFullYear() - new Date(birthDate).getFullYear();
        const ageGroup = Math.floor(age / 5) * 5; // 0-4, 5-9, 10-14...
        
        if (years.has(year1)) {
            ageGroupsYear1[ageGroup] = (ageGroupsYear1[ageGroup] || 0) + 1;
        }
        if (years.has(year2)) {
            ageGroupsYear2[ageGroup] = (ageGroupsYear2[ageGroup] || 0) + 1;
        }
    });
    
    console.log(`ğŸ“Š ${year1}å¹´é½¡åˆ†å¸ƒ:`, ageGroupsYear1);
    console.log(`ğŸ“Š ${year2}å¹´é½¡åˆ†å¸ƒ:`, ageGroupsYear2);
    
    // ç”Ÿæˆåœ–è¡¨
    renderAgeChart('ageChart2024', ageGroupsYear1);
    renderAgeChart('ageChart2025', ageGroupsYear2);
}

function renderAgeChart(containerId, ageGroups) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    if (Object.keys(ageGroups).length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">ç„¡è³‡æ–™</div>';
        return;
    }
    
    // æ’åºå¹´é½¡çµ„
    const sortedGroups = Object.entries(ageGroups).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
    const maxCount = Math.max(...sortedGroups.map(([_, count]) => count));
    
    sortedGroups.forEach(([ageGroup, count]) => {
        const ageEnd = parseInt(ageGroup) + 4;
        const percentage = (count / maxCount) * 100;
        
        const barItem = document.createElement('div');
        barItem.className = 'age-bar-item';
        barItem.innerHTML = `
            <span class="age-label">${ageGroup}-${ageEnd}æ­²</span>
            <div class="age-bar-track">
                <div class="age-bar-fill" style="width: ${percentage}%"></div>
            </div>
            <span class="age-count">${count}</span>
        `;
        container.appendChild(barItem);
    });
}

function closeDetailModal() {
    const modal = document.getElementById('detailModal');
    modal.classList.remove('show');
    currentDetailDisease = null;
}

function executeCQLFromModal() {
    if (currentDetailDisease) {
        closeDetailModal();
        executeCQL(currentDetailDisease);
    }
}

function exportDetailData() {
    if (!currentDetailDisease || !currentResults[currentDetailDisease]) {
        showNotification('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™', 'warning');
        return;
    }
    
    const results = currentResults[currentDetailDisease];
    const diseaseNames = {
        'covid19': 'COVID-19',
        'influenza': 'æµæ„Ÿ',
        'conjunctivitis': 'æ€¥æ€§çµè†œç‚',
        'enterovirus': 'è…¸ç—…æ¯’',
        'diarrhea': 'è…¹ç€‰ç¾¤èš'
    };
    
    const exportData = {
        ç–¾ç—…é¡å‹: diseaseNames[currentDetailDisease],
        æŸ¥è©¢æ™‚é–“: new Date().toISOString(),
        ç¸½ç—…ä¾‹æ•¸: results.totalCases,
        æœ¬æ—¥æ–°å¢: results.newCasesToday,
        å°±è¨ºè¨˜éŒ„: results.encounters?.length || 0,
        è¨ºæ–·è¨˜éŒ„: results.conditions?.length || 0,
        æ‚£è€…æ•¸: results.patients?.length || 0,
        æª¢é©—è¨˜éŒ„: results.observations?.length || 0
    };
    
    const json = JSON.stringify(exportData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${diseaseNames[currentDetailDisease]}_è©³ç´°è³‡æ–™_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    
    showNotification('è©³ç´°è³‡æ–™å·²åŒ¯å‡º', 'success');
}

// é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
document.getElementById('detailModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeDetailModal();
    }
});

// å…¨åŸŸè®Šæ•¸å„²å­˜ç•¶å‰è©³ç´°å ±å‘Šçš„ç–¾ç—…é¡å‹
let currentDetailDisease = null;

// å°‡ showDetailReport å®šç¾©ç‚ºå…¨åŸŸå‡½æ•¸
window.showDetailReport = function(diseaseType) {
    console.log('========== showDetailReport è¢«èª¿ç”¨ ==========');
    console.log('ç–¾ç—…é¡å‹:', diseaseType);
    console.log('currentResults:', currentResults);
    console.log('è©²ç–¾ç—…çµæœ:', currentResults[diseaseType]);
    
    // æ¸¬è©¦:å…ˆé¡¯ç¤ºä¸€å€‹ç°¡å–®çš„ alert
    alert('showDetailReport å‡½æ•¸è¢«èª¿ç”¨äº†! ç–¾ç—…: ' + diseaseType);
    
    // æª¢æŸ¥æ˜¯å¦æœ‰æŸ¥è©¢çµæœ
    if (!currentResults[diseaseType]) {
        console.log('æ²’æœ‰æŸ¥è©¢çµæœ');
        showNotification('è«‹å…ˆé»æ“Š"åŸ·è¡ŒæŸ¥è©¢"æŒ‰éˆ•', 'warning');
        return;
    }
    
    console.log('æœ‰æŸ¥è©¢çµæœ,ç¹¼çºŒè™•ç†...');
    const results = currentResults[diseaseType];
    const diseaseNames = {
        'covid19': 'COVID-19',
        'influenza': 'æµæ„Ÿ',
        'conjunctivitis': 'æ€¥æ€§çµè†œç‚',
        'enterovirus': 'è…¸ç—…æ¯’',
        'diarrhea': 'æ€¥æ€§è…¹ç€‰'
    };
    
    // è¨ˆç®—å”¯ä¸€æ‚£è€…æ•¸
    let uniquePatients = new Set();
    if (results.conditions && results.conditions.length > 0) {
        results.conditions.forEach(condition => {
            const patientRef = condition.subject?.reference;
            if (patientRef) {
                uniquePatients.add(patientRef.split('/').pop());
            }
        });
    } else if (results.encounters && results.encounters.length > 0) {
        results.encounters.forEach(encounter => {
            const patientRef = encounter.subject?.reference;
            if (patientRef) {
                uniquePatients.add(patientRef.split('/').pop());
            }
        });
    }
    
    // è¨ˆç®—å°±è¨ºé¡å‹çµ±è¨ˆ
    let emergencyCount = 0, inpatientCount = 0, outpatientCount = 0;
    if (results.encounters) {
        results.encounters.forEach(enc => {
            const classCode = enc.class?.code || enc.class?.display || '';
            if (classCode.toLowerCase().includes('emerg')) emergencyCount++;
            else if (classCode.toLowerCase().includes('inp')) inpatientCount++;
            else if (classCode.toLowerCase().includes('out') || classCode.toLowerCase().includes('amb')) outpatientCount++;
        });
    }
    
    // æ§‹å»ºè©³ç´°å ±å‘ŠHTML
    const reportHTML = `
        <div style="background: white; padding: 2rem; border-radius: 16px; max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">
                <h2 style="margin: 0; color: #1e293b; font-size: 1.5rem;">
                    <i class="fas fa-file-medical"></i> ${diseaseNames[diseaseType]} è©³ç´°å ±å‘Š
                </h2>
                <button onclick="closeDetailReport()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 12px; color: white;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">ç¸½æ‚£è€…æ•¸</div>
                    <div style="font-size: 2rem; font-weight: 700;">${uniquePatients.size}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">å”¯ä¸€æ‚£è€…</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 1.5rem; border-radius: 12px; color: white;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">å°±è¨ºè¨˜éŒ„</div>
                    <div style="font-size: 2rem; font-weight: 700;">${results.encounters?.length || 0}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">ç¸½æ¬¡æ•¸</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 1.5rem; border-radius: 12px; color: white;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">è¨ºæ–·è¨˜éŒ„</div>
                    <div style="font-size: 2rem; font-weight: 700;">${results.conditions?.length || 0}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">ç¸½ç­†æ•¸</div>
                </div>
                
                <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 1.5rem; border-radius: 12px; color: white;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">æª¢é©—è¨˜éŒ„</div>
                    <div style="font-size: 2rem; font-weight: 700;">${results.observations?.length || 0}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">ç¸½ç­†æ•¸</div>
                </div>
            </div>
            
            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">
                    <i class="fas fa-hospital"></i> å°±è¨ºé¡å‹åˆ†å¸ƒ
                </h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                    <div>
                        <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.5rem;">æ€¥è¨º</div>
                        <div style="color: #ef4444; font-size: 1.5rem; font-weight: 700;">${emergencyCount}</div>
                    </div>
                    <div>
                        <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.5rem;">ä½é™¢</div>
                        <div style="color: #8b5cf6; font-size: 1.5rem; font-weight: 700;">${inpatientCount}</div>
                    </div>
                    <div>
                        <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.5rem;">é–€è¨º</div>
                        <div style="color: #3b82f6; font-size: 1.5rem; font-weight: 700;">${outpatientCount}</div>
                    </div>
                </div>
            </div>
            
            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                <h3 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem;">
                    <i class="fas fa-info-circle"></i> æŸ¥è©¢è³‡è¨Š
                </h3>
                <div style="color: #64748b; font-size: 0.9rem; line-height: 1.8;">
                    <div><strong>FHIR ä¼ºæœå™¨:</strong> ${window.fhirServer || 'https://hapi.fhir.org/baseR4'}</div>
                    <div><strong>æŸ¥è©¢æ™‚é–“:</strong> ${new Date().toLocaleString('zh-TW')}</div>
                    <div><strong>è³‡æ–™ç¯„åœ:</strong> æ‰€æœ‰å¯ç”¨è³‡æ–™</div>
                    <div><strong>æŸ¥è©¢ä¸Šé™:</strong> 1000ç­†</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="closeDetailReport()" style="padding: 0.75rem 1.5rem; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-times"></i> é—œé–‰
                </button>
            </div>
        </div>
    `;
    
    // å‰µå»ºæˆ–é¡¯ç¤ºæ¨¡æ…‹çª—å£
    let modal = document.getElementById('detailReportModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'detailReportModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 2rem;';
        document.body.appendChild(modal);
    }
    
    modal.innerHTML = reportHTML;
    modal.style.display = 'flex';
    
    // ä¿å­˜ç•¶å‰ç–¾ç—…é¡å‹ä»¥ä¾›åŒ¯å‡ºä½¿ç”¨
    currentDetailDisease = diseaseType;
};

// é—œé–‰è©³ç´°å ±å‘Šä¹Ÿè¨­ç‚ºå…¨åŸŸå‡½æ•¸
window.closeDetailReport = function() {
    const modal = document.getElementById('detailReportModal');
    if (modal) {
        modal.style.display = 'none';
    }
};
