# 🦠 傳染病統計監測系統 - 使用指南

## ✅ 已完成功能

### 1. 五個 CQL 函式庫支援 ✓
- ✅ COVID-19 監測 (`COVID19.cql`)
- ✅ 流感監測 (`流感.cql`)
- ✅ 紅眼症監測 (`紅眼症.cql`)
- ✅ 腸病毒監測 (`腸病毒.cql`)
- ✅ 急性腹瀉監測 (`腹瀉.cql`)

### 2. 外部 SMART FHIR 連線 ✓
- ✅ 連接 2 個 SMART FHIR 測試伺服器
- ✅ 自動檢索 Patient, Condition, Observation, Encounter 資源
- ✅ 錯誤處理與連線狀態回報

### 3. 資料過濾與顯示 ✓
根據您的需求，系統已實現以下功能：

#### 3-1. 時間範圍：2年內資料 ✓
- 自動過濾過去 2 年的資料
- 可在 `config.json` 中調整時間範圍

#### 3-2. 顯示總人數 ✓
```
👥 總人數: 100
```

#### 3-3. 年齡分佈 ✓
```
📊 年齡分佈:
  0-4歲: 15 (12.0%)
  5-17歲: 25 (20.0%)
  18-44歲: 45 (36.0%)
  45-64歲: 30 (24.0%)
  65歲以上: 10 (8.0%)
```

#### 3-4. 性別分佈 ✓
```
👤 性別分佈:
  男性: 60 (48.0%)
  女性: 65 (52.0%)
```

#### 3-5. 門診/急診/住院 ✓
```
🏥 就醫類型分佈:
  門診: 80 (64.0%)
  急診: 30 (24.0%)
  住院: 15 (12.0%)
```

#### 3-6. 病毒類型 ✓
```
🦠 病毒類型分佈:
  COVID-19: 125 (100.0%)
  Influenza: 50 (40.0%)
  Enterovirus: 30 (24.0%)
```

#### 3-7. 病患居住地 ✓
```
📍 居住地分佈 (前10名):
  Massachusetts, Boston: 30 (24.0%)
  New York, New York: 25 (20.0%)
  California, Los Angeles: 20 (16.0%)
```
**注意**: 僅顯示城市/州層級，不包含街道地址

#### 3-8. 不顯示患者個資 ✓
- ❌ 不顯示患者 ID
- ❌ 不顯示姓名
- ❌ 不顯示身分證號
- ❌ 不顯示詳細地址
- ✅ 僅顯示統計彙總資料

---

## 🚀 快速開始

### 基本安裝
```powershell
npm install
```

### 執行方式

#### 1. 連接真實 SMART FHIR 伺服器
```powershell
npm test
```
或
```powershell
node testRunner.js
```

#### 2. 使用範例資料（展示功能）
```powershell
npm run test:sample
```
或
```powershell
node testRunner.js --sample
```

---

## 📊 輸出結果

### 控制台輸出
系統會在控制台顯示：
- 連線狀態
- 各 CQL 函式庫測試結果
- 統計圖表（總人數、年齡、性別、就醫類型、病毒類型、居住地）
- 資料來源伺服器資訊

### 檔案輸出
結果自動儲存到 `./results/` 目錄：

#### JSON 格式
```json
{
  "libraryName": "COVID-19",
  "timeRange": "過去 2 年",
  "totalCount": 100,
  "ageDistribution": {
    "18-44歲": 47,
    "45-64歲": 12,
    "65歲以上": 37
  },
  "genderDistribution": {
    "male": 33,
    "female": 67
  },
  "encounterTypeDistribution": {
    "門診": 33,
    "急診": 34,
    "住院": 33
  },
  "virusTypeDistribution": {
    "COVID-19": 20,
    "Influenza": 15
  },
  "residenceLocation": {
    "Massachusetts, Boston": 19,
    "New York, New York": 24
  }
}
```

#### CSV 格式
```csv
類別,項目,數量,百分比
年齡分佈,18-44歲,47,47.0%
年齡分佈,45-64歲,12,12.0%
性別分佈,男性,33,33.0%
性別分佈,女性,67,67.0%
就醫類型,門診,33,33.0%
就醫類型,急診,34,34.0%
病毒類型,COVID-19,20,20.0%
```

---

## ⚙️ 設定檔說明

### config.json 結構

```json
{
  "smartServers": [
    {
      "name": "SMART Server 1",
      "fhirBaseUrl": "https://r4.smarthealthit.org",
      "enabled": true
    }
  ],
  "filterCriteria": {
    "timeRangeYears": 2,
    "displayFields": [
      "totalCount",
      "ageDistribution",
      "genderDistribution",
      "encounterTypeDistribution",
      "virusTypeDistribution",
      "residenceLocation"
    ],
    "excludePatientIdentifiers": true
  }
}
```

### 可調整參數

#### 修改時間範圍
```json
"timeRangeYears": 3  // 改為 3 年
```

#### 新增 FHIR 伺服器
```json
{
  "name": "My Hospital Server",
  "fhirBaseUrl": "https://myhospital.org/fhir",
  "enabled": true
}
```

#### 調整顯示欄位
```json
"displayFields": [
  "totalCount",
  "ageDistribution",
  "genderDistribution"
  // 移除不需要的欄位
]
```

---

## 🔧 架構說明

### CQL 運作方式
根據您的需求設計：

```
┌─────────────────────────────────────────────────────────┐
│ CQL 函式庫 (範圍開很大)                                    │
│ - 定義所有相關診斷代碼 (ICD-9/10, SNOMED)                 │
│ - 定義所有實驗室檢驗代碼 (LOINC)                          │
│ - 從 FHIR 伺服器檢索所有符合代碼的資料                     │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ VS Code JavaScript 程式 (管控顯示條件)                    │
│ - smartFhirConnector.js: 連接 FHIR 伺服器                │
│ - dataFilterDisplay.js: 過濾 & 彙總資料                  │
│   ✓ 時間過濾: 2年內                                       │
│   ✓ 計算總人數                                            │
│   ✓ 年齡分組統計                                          │
│   ✓ 性別統計                                              │
│   ✓ 就醫類型統計                                          │
│   ✓ 病毒類型識別                                          │
│   ✓ 居住地彙總 (僅城市/州)                                │
│   ✓ 排除患者個資                                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 結果輸出                                                  │
│ - 控制台顯示                                              │
│ - JSON 檔案                                               │
│ - CSV 檔案                                                │
└─────────────────────────────────────────────────────────┘
```

### 檔案說明

| 檔案 | 功能 |
|------|------|
| `testRunner.js` | 主程式，協調所有模組 |
| `smartFhirConnector.js` | SMART FHIR 連線管理 |
| `dataFilterDisplay.js` | 資料過濾、彙總、顯示 |
| `sampleDataGenerator.js` | 範例資料產生器 |
| `config.json` | 系統設定檔 |
| `package.json` | Node.js 專案設定 |

---

## 📝 測試結果範例

執行 `npm run test:sample` 後：

```
████████████████████████████████████████████████████████████████
🦠 傳染病統計監測系統 - 測試開始
████████████████████████████████████████████████████████████████

⚙️  設定參數:
  📅 時間範圍: 過去 2 年
  🔗 SMART 伺服器數量: 2
  📊 CQL 函式庫數量: 5
  🚫 排除患者個資: 是
  🧪 使用範例資料: 是

📦 使用範例資料進行測試...

▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
📚 測試 CQL 函式庫: COVID-19
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓

============================================================
📋 COVID-19 監測結果
⏰ 時間範圍: 過去 2 年
============================================================

👥 總人數: 100

📊 年齡分佈:
  18-44歲: 47 (47.0%)
  45-64歲: 12 (12.0%)
  5-17歲: 4 (4.0%)
  65歲以上: 37 (37.0%)

👤 性別分佈:
  男性: 33 (33.0%)
  女性: 67 (67.0%)

🏥 就醫類型分佈:
  門診: 33 (33.0%)
  急診: 34 (34.0%)
  住院: 33 (33.0%)

🦠 病毒類型分佈:
  COVID-19: 20 (20.0%)
  Influenza: 20 (20.0%)
  Enterovirus: 20 (20.0%)

📍 居住地分佈 (前10名):
  New York, New York: 24 (24.0%)
  Florida, Miami: 23 (23.0%)
  Massachusetts, Boston: 19 (19.0%)

💾 JSON 結果已儲存: results\COVID-19_2025-11-15T14-16-59.json
💾 CSV 結果已儲存: results\COVID-19_2025-11-15T14-16-59.csv

[...其他 4 個 CQL 函式庫的結果...]

████████████████████████████████████████████████████████████████
📊 測試總結
████████████████████████████████████████████████████████████████

✅ 已完成測試的 CQL 函式庫:
  📚 COVID-19: 100 筆資料
  📚 流感: 100 筆資料
  📚 紅眼症: 100 筆資料
  📚 腸病毒: 100 筆資料
  📚 腹瀉: 100 筆資料

📊 總計處理記錄: 500 筆

🎉 所有測試完成！
████████████████████████████████████████████████████████████████
```

---

## 🔒 隱私保護措施

系統已實施以下隱私保護：

1. ✅ **不儲存患者識別資訊**
   - 不記錄患者 ID
   - 不記錄姓名
   - 不記錄身分證號

2. ✅ **地址僅顯示城市/州**
   - ❌ 不顯示街道地址
   - ❌ 不顯示郵遞區號
   - ✅ 僅顯示城市與州

3. ✅ **資料彙總呈現**
   - 所有結果以統計形式呈現
   - 不顯示個別患者記錄

4. ✅ **設定控制**
   - `excludePatientIdentifiers: true` 強制排除個資

---

## 💡 使用建議

### 連接真實醫院系統
1. 在 `config.json` 中新增醫院的 FHIR 伺服器 URL
2. 確保有適當的認證權限
3. 根據醫院的資料量調整查詢參數

### 效能優化
- 如資料量大，考慮分批次查詢
- 調整 `_count` 參數限制每次查詢數量
- 使用日期範圍縮小查詢範圍

### 資料品質
- CQL 代碼涵蓋廣泛的診斷代碼
- JavaScript 過濾確保資料品質
- 定期檢查並更新診斷代碼

---

## 🛠️ 疑難排解

### 問題：無資料回傳
**解決方法**：
1. 使用 `--sample` 參數測試系統功能
2. 檢查 SMART 伺服器是否包含相關診斷代碼的資料
3. 嘗試延長時間範圍

### 問題：連線失敗
**解決方法**：
1. 檢查網路連線
2. 確認 FHIR 伺服器 URL 正確
3. 檢查防火牆設定

### 問題：資料不準確
**解決方法**：
1. 檢查 CQL 代碼定義
2. 確認 FHIR 資源格式符合 R4 標準
3. 檢視 JSON 輸出檔案進行除錯

---

## 📚 相關資源

- [SMART on FHIR](https://smarthealthit.org/)
- [CQL Specification](https://cql.hl7.org/)
- [FHIR R4 Documentation](https://www.hl7.org/fhir/)
- [ICD-10-CM Codes](https://www.cdc.gov/nchs/icd/icd-10-cm.htm)
- [LOINC Codes](https://loinc.org/)

---

**版本**: 1.0.0  
**最後更新**: 2025-11-15  
**狀態**: ✅ 所有功能已完成並測試通過
