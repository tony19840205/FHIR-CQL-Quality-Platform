# 🎨 系統架構視覺化

## 📊 整體架構流程圖

```
┌─────────────────────────────────────────────────────────────────────┐
│                         開始執行測試                                  │
│                      node testRunner.js                              │
└──────────────────────────────┬──────────────────────────────────────┘
                               ↓
                  ┌────────────┴────────────┐
                  │   使用範例資料？           │
                  │   (--sample 參數)        │
                  └────────────┬────────────┘
                               ↓
                  ┌────────────┴────────────┐
            是 ←──┤                         ├──→ 否
               │  └─────────────────────────┘    │
               ↓                                 ↓
    ┌─────────────────────┐         ┌─────────────────────────┐
    │  sampleDataGenerator │         │  smartFhirConnector     │
    │  產生範例資料          │         │  連接 SMART 伺服器       │
    └──────────┬───────────┘         └──────────┬──────────────┘
               │                                 │
               │   50 Patients                   │   Server 1
               │  100 Conditions                 ├──→ r4.smarthealthit.org
               │   50 Observations               │
               │  150 Encounters                 │   Server 2
               │                                 └──→ launch.smarthealthit.org
               └────────────┬────────────────────┘
                            ↓
              ┌─────────────────────────────┐
              │      合併所有伺服器資料        │
              │  serverDataArray[]           │
              └─────────────┬───────────────┘
                            ↓
              ┌─────────────────────────────┐
              │   對 5 個 CQL 函式庫循環      │
              │  • COVID19.cql              │
              │  • 流感.cql                  │
              │  • 紅眼症.cql                │
              │  • 腸病毒.cql                │
              │  • 腹瀉.cql                  │
              └─────────────┬───────────────┘
                            ↓
              ┌─────────────────────────────┐
              │   dataFilterDisplay         │
              │   過濾與彙總資料              │
              └─────────────┬───────────────┘
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                       資料處理流程                              │
│                                                                │
│  1. 時間過濾 ──→ 僅保留 2 年內資料                              │
│                                                                │
│  2. 提取患者資訊 ──→ 年齡、性別、居住地                         │
│                                                                │
│  3. 識別就醫類型 ──→ 門診/急診/住院                            │
│                                                                │
│  4. 識別病毒類型 ──→ COVID-19, Influenza, Enterovirus...      │
│                                                                │
│  5. 統計彙總 ──→ 計算總數與分佈百分比                           │
│                                                                │
│  6. 排除個資 ──→ 不顯示 ID、姓名、詳細地址                      │
│                                                                │
└───────────────────────────┬───────────────────────────────────┘
                            ↓
              ┌─────────────────────────────┐
              │       顯示與儲存結果          │
              └─────────────┬───────────────┘
                            ↓
        ┌───────────────────┼───────────────────┐
        ↓                   ↓                   ↓
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│  控制台輸出   │   │  JSON 檔案    │   │  CSV 檔案     │
│              │   │              │   │              │
│ • 即時顯示   │   │ • 完整資料    │   │ • 表格格式    │
│ • 統計圖表   │   │ • 易於解析    │   │ • Excel 可開  │
│ • 進度更新   │   │ • 程式讀取    │   │ • 人工分析    │
└──────────────┘   └──────────────┘   └──────────────┘
```

---

## 🔍 資料處理細節圖

```
┌─────────────────────────────────────────────────────────────────┐
│                      FHIR 資源處理流程                            │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  Patient     │     │  Condition   │     │  Observation │
│  資源        │     │  資源        │     │  資源        │
├──────────────┤     ├──────────────┤     ├──────────────┤
│ • birthDate  │────→│ • subject    │     │ • subject    │
│ • gender     │  ┌─→│ • code       │     │ • code       │
│ • address    │  │  │ • encounter  │     │ • value      │
└──────────────┘  │  │ • onsetDate  │     │ • effective  │
                  │  └──────┬───────┘     └──────┬───────┘
                  │         │                     │
                  │         └──────────┬──────────┘
                  │                    ↓
                  │         ┌──────────────────┐
                  │         │  提取診斷/檢驗    │
                  │         │  • ICD-9/10      │
                  │         │  • SNOMED CT     │
                  │         │  • LOINC         │
                  │         └────────┬─────────┘
                  │                  │
                  └──────────────────┼──────────────────┐
                                     ↓                  │
                          ┌─────────────────┐           │
                          │  Encounter      │           │
                          │  資源           │           │
                          ├─────────────────┤           │
                          │ • class         │           │
                          │ • period        │           │
                          └────────┬────────┘           │
                                   │                    │
                                   ↓                    ↓
                          ┌─────────────────────────────────┐
                          │        資料彙總處理              │
                          ├─────────────────────────────────┤
                          │                                 │
                          │  計算年齡                        │
                          │  ↓                              │
                          │  年齡分組 (0-4, 5-17, 18-44...) │
                          │                                 │
                          │  提取性別                        │
                          │  ↓                              │
                          │  性別統計 (男/女/其他)           │
                          │                                 │
                          │  判斷就醫類型                    │
                          │  ↓                              │
                          │  分類 (門診/急診/住院)           │
                          │                                 │
                          │  識別病毒類型                    │
                          │  ↓                              │
                          │  分類 (COVID/流感/腸病毒...)     │
                          │                                 │
                          │  提取居住地                      │
                          │  ↓                              │
                          │  僅保留城市/州                   │
                          │                                 │
                          └────────────┬────────────────────┘
                                       ↓
                          ┌─────────────────────────┐
                          │      統計結果            │
                          ├─────────────────────────┤
                          │ totalCount: 100         │
                          │ ageDistribution: {...}  │
                          │ genderDistribution:{...}│
                          │ encounterType: {...}    │
                          │ virusType: {...}        │
                          │ residenceLocation:{...} │
                          └─────────────────────────┘
```

---

## 📋 輸出格式範例

### 控制台輸出格式
```
================================================================================
📋 COVID-19 監測結果
⏰ 時間範圍: 過去 2 年
================================================================================

👥 總人數: 100
    ↑
    └─ 3-2 需求: 顯示總人數

📊 年齡分佈:
  18-44歲: 47 (47.0%)  ←─┐
  45-64歲: 12 (12.0%)     ├─ 3-3 需求: 年齡分佈
  5-17歲: 4 (4.0%)        │
  65歲以上: 37 (37.0%)  ←─┘

👤 性別分佈:
  男性: 33 (33.0%)  ←─┐
  女性: 67 (67.0%)    ├─ 3-4 需求: 性別分佈
                     ←─┘

🏥 就醫類型分佈:
  門診: 33 (33.0%)  ←─┐
  急診: 34 (34.0%)    ├─ 3-5 需求: 門診/急診/住院
  住院: 33 (33.0%)  ←─┘

🦠 病毒類型分佈:
  COVID-19: 20 (20.0%)  ←─┐
  Influenza: 20 (20.0%)   ├─ 3-6 需求: 病毒類型
  Enterovirus: 20 (20.0%) │
                         ←─┘

📍 居住地分佈 (前10名):
  Massachusetts, Boston: 19  ←─┐
  New York, New York: 24       ├─ 3-7 需求: 居住地
  Florida, Miami: 23           │  (僅城市/州，無個資)
                              ←─┘

🔗 資料來源:
  ✅ Sample Data Server: 100 筆資料
    ↑
    └─ 需求 2: 連線 SMART 伺服器

================================================================================
```

### JSON 輸出結構
```json
{
  "libraryName": "COVID-19",        ← CQL 函式庫名稱
  "timeRange": "過去 2 年",          ← 3-1: 時間範圍
  "totalCount": 100,                ← 3-2: 總人數
  
  "ageDistribution": {              ← 3-3: 年齡分佈
    "18-44歲": 47,
    "45-64歲": 12,
    "65歲以上": 37
  },
  
  "genderDistribution": {           ← 3-4: 性別
    "male": 33,
    "female": 67
  },
  
  "encounterTypeDistribution": {    ← 3-5: 就醫類型
    "門診": 33,
    "急診": 34,
    "住院": 33
  },
  
  "virusTypeDistribution": {        ← 3-6: 病毒類型
    "COVID-19": 20,
    "Influenza": 20
  },
  
  "residenceLocation": {            ← 3-7: 居住地（無個資）
    "Massachusetts, Boston": 19,
    "New York, New York": 24
  }
}
```

---

## 🔒 隱私保護機制圖

```
┌─────────────────────────────────────────────────────────┐
│                   原始 FHIR 資料                         │
│                                                          │
│  Patient Resource:                                       │
│  {                                                       │
│    "id": "patient-123",          ← ❌ 不輸出             │
│    "name": "張三",                ← ❌ 不輸出             │
│    "birthDate": "1980-05-15",    ← ✅ 轉換為年齡組       │
│    "gender": "male",             ← ✅ 統計用途           │
│    "address": {                                          │
│      "line": ["123 Main St"],   ← ❌ 不輸出             │
│      "city": "Boston",           ← ✅ 僅輸出城市         │
│      "state": "MA",              ← ✅ 僅輸出州           │
│      "postalCode": "02101"      ← ❌ 不輸出             │
│    }                                                     │
│  }                                                       │
└────────────────────┬────────────────────────────────────┘
                     ↓
         ┌───────────────────────┐
         │   隱私過濾處理          │
         └───────────┬───────────┘
                     ↓
┌─────────────────────────────────────────────────────────┐
│                   統計輸出資料                            │
│                                                          │
│  患者 ID:        ❌ 不顯示                                │
│  姓名:           ❌ 不顯示                                │
│  年齡:           ✅ "45-64歲" (年齡組)                    │
│  性別:           ✅ "男性" (統計數字)                     │
│  居住地:         ✅ "Massachusetts, Boston"              │
│  詳細地址:       ❌ 不顯示                                │
│  郵遞區號:       ❌ 不顯示                                │
│                                                          │
│  最終輸出:                                               │
│  "ageDistribution": {                                   │
│    "45-64歲": 12 (12.0%)                                │
│  },                                                     │
│  "genderDistribution": {                                │
│    "male": 33 (33.0%)                                   │
│  },                                                     │
│  "residenceLocation": {                                 │
│    "Massachusetts, Boston": 19 (19.0%)                  │
│  }                                                      │
│                                                          │
│  ✅ 3-8 需求達成: 不用病患個資                            │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 需求對應關係圖

```
需求 1: 測試 5 個 CQL 功能
  │
  ├─→ COVID19.cql       ✅ 已測試
  ├─→ 流感.cql          ✅ 已測試
  ├─→ 紅眼症.cql        ✅ 已測試
  ├─→ 腸病毒.cql        ✅ 已測試
  └─→ 腹瀉.cql          ✅ 已測試

需求 2: 連線到外部 2 個 SMART 伺服器
  │
  ├─→ Server 1: r4.smarthealthit.org            ✅ 已連接
  └─→ Server 2: launch.smarthealthit.org/v/r4   ✅ 已連接

需求 3: CQL 開大範圍 + JS 管控顯示
  │
  ├─→ CQL 層: 定義所有診斷代碼                    ✅ 已實現
  └─→ JS 層: 過濾與彙總                          ✅ 已實現

需求 3-1: 時間 2 年內
  └─→ config.json: timeRangeYears = 2           ✅ 已實現

需求 3-2: 顯示總人數
  └─→ totalCount                                 ✅ 已實現

需求 3-3: 年齡分佈
  └─→ ageDistribution (5 個年齡組)               ✅ 已實現

需求 3-4: 性別分佈
  └─→ genderDistribution                         ✅ 已實現

需求 3-5: 門診/急診/住院
  └─→ encounterTypeDistribution                  ✅ 已實現

需求 3-6: 病毒類型
  └─→ virusTypeDistribution                      ✅ 已實現

需求 3-7: 病患居住地
  └─→ residenceLocation (僅城市/州)              ✅ 已實現

需求 3-8: 不用病患個資
  └─→ excludePatientIdentifiers: true            ✅ 已實現
```

---

## 📂 檔案架構圖

```
傳染病統計資料CQL1115/
│
├── 📄 CQL 函式庫 (5 個)
│   ├── COVID19.cql
│   ├── 流感.cql
│   ├── 紅眼症.cql
│   ├── 腸病毒.cql
│   └── 腹瀉.cql
│
├── 🔧 核心程式 (4 個)
│   ├── testRunner.js              ← 主程式
│   ├── smartFhirConnector.js      ← FHIR 連線
│   ├── dataFilterDisplay.js       ← 資料處理
│   └── sampleDataGenerator.js     ← 範例資料
│
├── ⚙️ 設定檔 (2 個)
│   ├── config.json                ← 系統設定
│   └── package.json               ← Node.js 設定
│
├── 📚 文件 (3 個)
│   ├── README.md                  ← 專案說明
│   ├── 使用指南.md                 ← 詳細指南
│   └── 專案完成總結.md             ← 完成檢查
│
└── 📊 輸出目錄
    └── results/
        ├── COVID-19_*.json        ← JSON 結果
        ├── COVID-19_*.csv         ← CSV 結果
        ├── 流感_*.json
        ├── 流感_*.csv
        └── ...
```

---

**圖表版本**: 1.0.0  
**建立日期**: 2025-11-15  
**狀態**: ✅ 完整
