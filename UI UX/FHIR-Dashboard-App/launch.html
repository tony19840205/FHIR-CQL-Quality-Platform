<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART on FHIR Launch - FHIR CQL é†«ç™‚å“è³ªæŒ‡æ¨™å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .launch-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 50px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            margin: 30px auto;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .success {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .info {
            color: #004085;
            background: #cce5ff;
            border: 1px solid #b8daff;
            font-size: 12px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="launch-container">
        <div class="logo">ğŸ¥</div>
        <h1>FHIR CQL é†«ç™‚å“è³ªæŒ‡æ¨™å¹³å°</h1>
        <p class="subtitle">SMART on FHIR Launch</p>
        
        <div class="spinner"></div>
        <div class="status" id="status">æ­£åœ¨è™•ç† SMART Launch æˆæ¬Š...</div>
        <div class="info" id="debug"></div>
    </div>

    <script>
        // SMART on FHIR Launch è™•ç†é‚è¼¯
        (async function() {
            const statusEl = document.getElementById('status');
            const debugEl = document.getElementById('debug');

            try {
                // å–å¾— URL åƒæ•¸
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const iss = urlParams.get('iss');
                const launch = urlParams.get('launch');

                debugEl.innerHTML = `
                    <strong>OAuth åƒæ•¸ï¼š</strong><br>
                    Code: ${code ? 'âœ“ å·²æ¥æ”¶' : 'âœ— æœªæ¥æ”¶'}<br>
                    State: ${state ? 'âœ“ å·²æ¥æ”¶' : 'âœ— æœªæ¥æ”¶'}<br>
                    ISS: ${iss || 'æœªæä¾›'}<br>
                    Launch: ${launch || 'æœªæä¾›'}
                `;

                if (!code) {
                    // å¦‚æœæ²’æœ‰æˆæ¬Šç¢¼ï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡é€²å…¥ï¼Œéœ€è¦é‡å®šå‘åˆ°æˆæ¬Šé é¢
                    if (iss) {
                        statusEl.textContent = 'æ­£åœ¨é‡å®šå‘åˆ°æˆæ¬Šé é¢...';
                        
                        // å»ºç«‹æˆæ¬Šè«‹æ±‚
                        const redirectUri = window.location.origin + window.location.pathname;
                        const clientId = 'fhir-cql-quality-platform'; // ä½ çš„ Client ID
                        const scope = 'patient/*.read launch openid fhirUser';
                        
                        // å–å¾— FHIR Server çš„æˆæ¬Šç«¯é»
                        const metadataUrl = `${iss}/metadata`;
                        const response = await fetch(metadataUrl);
                        const metadata = await response.json();
                        
                        // å°‹æ‰¾ OAuth æˆæ¬Šç«¯é»
                        const security = metadata.rest[0].security;
                        const authExtension = security.extension.find(ext => 
                            ext.url === 'http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris'
                        );
                        const authorizeUrl = authExtension.extension.find(ext => ext.url === 'authorize').valueUri;
                        
                        // é‡å®šå‘åˆ°æˆæ¬Šé é¢
                        const authUrl = `${authorizeUrl}?` +
                            `response_type=code&` +
                            `client_id=${encodeURIComponent(clientId)}&` +
                            `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                            `launch=${encodeURIComponent(launch)}&` +
                            `scope=${encodeURIComponent(scope)}&` +
                            `state=${encodeURIComponent(state || 'random-state')}&` +
                            `aud=${encodeURIComponent(iss)}`;
                        
                        window.location.href = authUrl;
                        return;
                    } else {
                        throw new Error('ç¼ºå°‘å¿…è¦çš„ OAuth åƒæ•¸ (code æˆ– iss)');
                    }
                }

                // å¦‚æœæœ‰æˆæ¬Šç¢¼ï¼Œè™•ç† token äº¤æ›
                statusEl.textContent = 'æ­£åœ¨äº¤æ›å­˜å–ä»¤ç‰Œ...';

                // å„²å­˜æˆæ¬Šè³‡è¨Šåˆ° localStorage
                const authData = {
                    code: code,
                    state: state,
                    iss: iss,
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('smart_auth', JSON.stringify(authData));
                localStorage.setItem('fhirServer', iss);

                // æ›´æ–°ç‹€æ…‹
                statusEl.className = 'status success';
                statusEl.textContent = 'âœ“ æˆæ¬ŠæˆåŠŸï¼æ­£åœ¨è·³è½‰åˆ°ä¸»é é¢...';

                // å»¶é² 1.5 ç§’å¾Œè·³è½‰åˆ°ä¸»é é¢
                setTimeout(() => {
                    window.location.href = './index.html?smart_launch=true';
                }, 1500);

            } catch (error) {
                console.error('SMART Launch Error:', error);
                
                statusEl.className = 'status error';
                statusEl.innerHTML = `
                    <strong>âŒ æˆæ¬Šå¤±æ•—</strong><br>
                    ${error.message}<br><br>
                    <small>æ­£åœ¨è·³è½‰åˆ°ä¸»é é¢ï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰...</small>
                `;

                debugEl.className = 'info error';
                debugEl.innerHTML += `<br><strong>éŒ¯èª¤è©³æƒ…ï¼š</strong> ${error.stack}`;

                // å³ä½¿å¤±æ•—ä¹Ÿè·³è½‰åˆ°ä¸»é é¢
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 3000);
            }
        })();
    </script>
</body>
</html>
