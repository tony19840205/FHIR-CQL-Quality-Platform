<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESG 指標儀表板 - FHIR CQL Platform</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/llm-connection.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- 導航欄 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-heartbeat"></i>
                <span>FHIR CQL Platform</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">首頁</a></li>
                <li><a href="disease-control.html">傳染病管制</a></li>
                <li><a href="public-health.html">國民健康</a></li>
                <li><a href="esg-indicators.html" class="active">ESG指標</a></li>
                <li><a href="quality-indicators.html">醫療品質</a></li>
            </ul>
            <div class="nav-settings" onclick="openLLMSettingsModal()" style="cursor: pointer;" title="LLM設定">
                <i class="fas fa-cog"></i>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <main class="main-content">
        <!-- 頁面標題 -->
        <section class="page-header">
            <div class="header-content">
                <h1><i class="fas fa-leaf"></i> ESG 指標儀表板</h1>
                <p>環境、社會與治理永續發展監測系統</p>
            </div>
            <div class="header-actions" style="position: relative;">
                <div style="display: flex; flex-direction: column; align-items: center; margin-right: 10px;">
                    <button class="btn btn-secondary" onclick="toggleDemoMode()" id="demoModeBtn">
                        <i class="fas fa-flask"></i> <span id="demoModeText">啟用示範模式</span>
                    </button>
                    <div style="font-size: 11px; color: #64748b; margin-top: 4px; text-align: center; line-height: 1.3;">
                        <span style="color: #10b981; font-weight: 600;">●</span> 綠色：模擬資料<br>
                        <span style="color: #94a3b8; font-weight: 600;">●</span> 灰色：FHIR資料
                    </div>
                </div>
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> 重新整理
                </button>
            </div>
        </section>

        <!-- FHIR 連線狀態 -->
        <section class="connection-banner" id="connectionBanner">
            <div class="banner-content">
                <i class="fas fa-exclamation-triangle"></i>
                <span>請先在首頁設定 FHIR 伺服器連線</span>
                <a href="index.html" class="btn btn-sm">前往設定</a>
            </div>
        </section>

        <!-- ESG 指標總覽 -->
        <section class="overview-section">
            <div class="section-header">
                <h2><i class="fas fa-globe"></i> ESG 永續指標</h2>
                <p>環境保護、社會責任與治理透明度</p>
            </div>
            
            <div class="overview-grid">
                <!-- 抗生素使用率 -->
                <div class="overview-card esg-social" onclick="showDetailModal('antibiotic')">
                    <div class="card-icon">
                        <i class="fas fa-pills"></i>
                    </div>
                    <div class="card-content">
                        <h3>抗生素使用率 <span class="cql-badge-mini">Antibiotic_Utilization</span></h3>
                        <div class="card-description">
                            <p>監測抗生素合理使用與抗藥性管理 <small style="color: #6366f1; font-weight: 600;">(國際算法)</small></p>
                            <ul class="card-features">
                                <li>✓ WHO ATC/DDD 標準</li>
                                <li>✓ Access/Watch/Reserve 分類</li>
                                <li>✓ 符合指引比例</li>
                            </ul>
                        </div>
                        <div class="card-stats">
                            <div class="stat-row">
                                <div class="stat-item-inline">
                                    <span class="stat-label">病人數</span>
                                    <span class="stat-value" id="antibioticCount">--</span>
                                </div>
                                <div class="stat-item-inline">
                                    <span class="stat-label">使用率</span>
                                    <span class="stat-value" id="antibioticRate">--%</span>
                                </div>
                            </div>
                            <div class="stat-date-range" id="antibioticDateRange">資料範圍: 全部資料</div>
                        </div>
                        <div class="card-actions">
                            <button class="btn-card-execute" id="btnAntibiotic" onclick="event.stopPropagation(); executeQuery('antibiotic')">
                                <i class="fas fa-play"></i> 執行查詢
                            </button>
                        </div>
                        <div class="card-status" id="statusAntibiotic"></div>
                    </div>
                    <div class="card-hover-hint">
                        <i class="fas fa-expand"></i> 點擊查看詳情
                    </div>
                </div>

                <!-- 電子病歷採用率 -->
                <div class="overview-card esg-governance" onclick="showDetailModal('ehr-adoption')">
                    <div class="card-icon">
                        <i class="fas fa-laptop-medical"></i>
                    </div>
                    <div class="card-content">
                        <h3>電子病歷採用率 <span class="cql-badge-mini">EHR_Adoption_Rate</span></h3>
                        <div class="card-description">
                            <p>追蹤病歷資料是否以結構化電子格式完整記錄 <small style="color: #6366f1;">(非紙本或掃描檔)</small></p>
                            <ul class="card-features">
                                <li>✓ 結構化資料完整度</li>
                                <li>✓ FHIR 標準互操作性</li>
                                <li>✓ 可機讀性比率</li>
                            </ul>
                        </div>
                        <div class="card-stats">
                            <div class="stat-row">
                                <div class="stat-item-inline">
                                    <span class="stat-label">病人數</span>
                                    <span class="stat-value" id="ehrCount">--</span>
                                </div>
                                <div class="stat-item-inline">
                                    <span class="stat-label">採用率</span>
                                    <span class="stat-value" id="ehrRate">--%</span>
                                </div>
                            </div>
                            <div class="stat-date-range" id="ehrDateRange">資料範圍: 全部資料</div>
                        </div>
                        <div class="card-actions">
                            <button class="btn-card-execute" id="btnEhr" onclick="event.stopPropagation(); executeQuery('ehr-adoption')">
                                <i class="fas fa-play"></i> 執行查詢
                            </button>
                        </div>
                        <div class="card-status" id="statusEhr"></div>
                    </div>
                    <div class="card-hover-hint">
                        <i class="fas fa-expand"></i> 點擊查看詳情
                    </div>
                </div>

                <!-- 廢棄物管理 -->
                <div class="overview-card esg-environment" onclick="showDetailModal('waste')">
                    <div class="card-icon">
                        <i class="fas fa-recycle"></i>
                    </div>
                    <div class="card-content">
                        <h3>醫療廢棄物管理 <span class="cql-badge-mini">Waste</span></h3>
                        <div class="card-description">
                            <p>監測醫療廢棄物產生與處理情況</p>
                            <ul class="card-features">
                                <li>✓ 廢棄物產生量</li>
                                <li>✓ 感染性廢棄物</li>
                                <li>✓ 回收再利用率</li>
                            </ul>
                        </div>
                        <div class="card-stats">
                            <div class="stat-row">
                                <div class="stat-item-inline">
                                    <span class="stat-label">廢棄物量</span>
                                    <span class="stat-value" id="wasteCount">--</span>
                                </div>
                                <div class="stat-item-inline">
                                    <span class="stat-label">回收率</span>
                                    <span class="stat-value" id="wasteRate">--%</span>
                                </div>
                            </div>
                            <div class="stat-date-range" id="wasteDateRange">資料範圍: 全部資料</div>
                        </div>
                        <div class="card-actions">
                            <button class="btn-card-execute" id="btnWaste" onclick="event.stopPropagation(); executeQuery('waste')">
                                <i class="fas fa-play"></i> 執行查詢
                            </button>
                        </div>
                        <div class="card-status" id="statusWaste"></div>
                    </div>
                    <div class="card-hover-hint">
                        <i class="fas fa-expand"></i> 點擊查看詳情
                    </div>
                </div>
            </div>
        </section>

        <!-- 詳細統計區 -->
        <section class="details-section" style="display: none;" id="detailsSection">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> 詳細數據分析</h2>
                <button class="btn btn-secondary" onclick="closeDetails()">
                    <i class="fas fa-times"></i> 關閉
                </button>
            </div>
            <div class="details-content" id="detailsContent">
                <!-- 動態載入詳細資訊 -->
            </div>
        </section>
    </main>

    <!-- 詳情 Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="modalTitle">詳細資訊</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 動態載入內容 -->
            </div>
        </div>
    </div>

    <!-- LLM 設定模態框 -->
    <div id="llmSettingsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
                <h3><i class="fas fa-brain"></i> LLM 連線控制台 - ESG指標儀表板</h3>
                <span class="modal-close" onclick="closeLLMSettingsModal()" style="color: white;">&times;</span>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <!-- LLM 服務控制 -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: #1e293b;">
                            <i class="fas fa-power-off"></i> 服務控制
                        </h4>
                        <div style="display: flex; gap: 0.75rem;">
                            <button id="uiConnectBtn" onclick="toggleUIConnection()" class="btn-external-service inactive">
                                <i class="fas fa-window-restore"></i> <span>連線 UI/UX</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 四節點連接狀態圖 -->
                    <div class="llm-connection-flow">
                        <div class="connection-flow-header">
                            <h5>連接狀態</h5>
                        </div>
                        
                        <div class="connection-nodes-container">
                            <!-- FHIR 伺服器 -->
                            <div class="connection-node node-fhir">
                                <div class="node-circle">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">FHIR</div>
                                    <div class="node-subtitle">伺服器</div>
                                </div>
                            </div>
                            
                            <!-- 連接線 1: FHIR → 控制網頁 -->
                            <div class="connection-line-wrapper">
                                <div class="connection-line line-fhir-control connected"></div>
                            </div>
                            
                            <!-- 控制網頁 -->
                            <div class="connection-node node-control">
                                <div class="node-circle">
                                    <i class="fas fa-desktop"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">控制網頁</div>
                                    <div class="node-subtitle">醫護人員</div>
                                </div>
                            </div>
                            
                            <!-- 連接線 2: 控制網頁 → 民眾網頁 -->
                            <div class="connection-line-wrapper">
                                <div class="connection-line line-control-public disconnected"></div>
                            </div>
                            
                            <!-- 民眾網頁 -->
                            <div class="connection-node node-public">
                                <div class="node-circle">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">民眾網頁</div>
                                    <div class="node-subtitle">公開版</div>
                                </div>
                            </div>
                            
                            <!-- 連接線 3: 民眾網頁 → LLM -->
                            <div class="connection-line-wrapper">
                                <div class="connection-line line-public-llm disconnected"></div>
                            </div>
                            
                            <!-- LLM 智能模型 -->
                            <div class="connection-node node-llm">
                                <div class="node-circle">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="node-label">
                                    <div class="node-title">LLM</div>
                                    <div class="node-subtitle">智能模型</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="connection-flow-status">
                            <i class="fas fa-info-circle"></i>
                            <span id="llmConnectionMessage">預設狀態: FHIR ↔ 控制網頁 | 民眾網頁 ↔ LLM (計費中)</span>
                        </div>
                    </div>
                </div>
                
                <!-- 使用狀態 -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 1rem 0; color: #1e293b;">
                        <i class="fas fa-chart-line"></i> 即時使用狀態
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                        <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 0.75rem; color: #1e40af; margin-bottom: 0.3rem;">查詢次數</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af;" id="queryCount">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-size: 0.75rem; color: #065f46; margin-bottom: 0.3rem;">輸入 Token</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #065f46;" id="inputTokens">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 0.75rem; color: #92400e; margin-bottom: 0.3rem;">輸出 Token</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #92400e;" id="outputTokens">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); padding: 1rem; border-radius: 8px; border-left: 4px solid #ec4899;">
                            <div style="font-size: 0.75rem; color: #831843; margin-bottom: 0.3rem;">資料傳輸</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #831843;" id="dataTransfer">0 KB</div>
                        </div>
                    </div>
                </div>
                
                <!-- 獲利金額 -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 1rem 0; color: #1e293b;">
                        <i class="fas fa-dollar-sign"></i> 獲利金額 (USD)
                    </h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 0.75rem; text-align: left; color: #64748b; font-weight: 600;">項目</th>
                                <th style="padding: 0.75rem; text-align: right; color: #64748b; font-weight: 600;">數量</th>
                                <th style="padding: 0.75rem; text-align: right; color: #64748b; font-weight: 600;">單價</th>
                                <th style="padding: 0.75rem; text-align: right; color: #64748b; font-weight: 600;">費用</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 0.75rem; color: #1e293b;">輸入 Token</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;" id="inputTokensTable">0</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;">$3.00 / 1M</td>
                                <td style="padding: 0.75rem; text-align: right; color: #10b981; font-weight: 600;" id="inputCost">$0.00</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 0.75rem; color: #1e293b;">輸出 Token</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;" id="outputTokensTable">0</td>
                                <td style="padding: 0.75rem; text-align: right; color: #64748b;">$15.00 / 1M</td>
                                <td style="padding: 0.75rem; text-align: right; color: #10b981; font-weight: 600;" id="outputCost">$0.00</td>
                            </tr>
                            <tr style="background: linear-gradient(135deg, #ecfdf5, #d1fae5); font-weight: 700;">
                                <td colspan="3" style="padding: 1rem; color: #065f46;">總計獲利</td>
                                <td style="padding: 1rem; text-align: right; color: #065f46; font-size: 1.2rem;" id="totalRevenue">$0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/fhir-connection.js"></script>
    <script src="js/cql-engine.js"></script>
    <script src="js/esg-indicators.js"></script>
    <script src="js/llm-service.js"></script>
    <script src="js/llm-connection-manager.js"></script>
</body>
</html>
