# 國民健康 CQL 測試系統 - 執行說明

## ✅ 測試成功！

您的 CQL 測試系統已成功連接到 2 個外部 SMART FHIR 伺服器，並擷取了資料。

## 📊 測試結果摘要

### 資料擷取統計
- **Patient (病人)**: 100 筆
- **Immunization (疫苗接種)**: 100 筆
- **Condition (診斷)**: 100 筆
- **Observation (觀察值)**: 100 筆

### 主要發現
- **病人性別分布**: 男性 50%，女性 50%
- **主要疫苗類型**: 
  - 流感疫苗: 62 劑
  - Td (成人破傷風白喉): 14 劑
  - 肺炎球菌疫苗 PCV 13: 6 劑

## 🚀 如何執行測試

### 方法：使用 PowerShell 腳本（推薦）

```powershell
cd "c:\Users\tony1\OneDrive\桌面\國民健康  CQL  1115"
.\test.ps1
```

**執行結果**：
- 自動連接 2 個 SMART FHIR 伺服器
- 擷取 Patient, Immunization, Condition, Observation 資料
- 顯示統計分析
- 產生 JSON 資料檔和 TXT 報告

## 📁 產生的檔案

執行後會產生以下檔案：

1. **`fhir_data_YYYYMMDD_HHMMSS.json`**: 完整的 FHIR 資料（JSON 格式）
2. **`report_YYYYMMDD_HHMMSS.txt`**: 測試報告（純文字格式）

## 🔧 系統架構

```
國民健康 CQL 1115/
├── config.json              # 配置檔案（伺服器設定）
├── test.ps1                 # PowerShell 測試腳本（✅ 推薦使用）
├── fhir_client.py          # Python FHIR 客戶端模組
├── data_processor.py       # Python 資料處理模組
├── display.py              # Python 報告顯示模組
├── main.py                 # Python 主程式
├── requirements.txt        # Python 套件需求
├── COVID19VaccinationCoverage.cql    # CQL: COVID-19 疫苗涵蓋率
├── HypertensionActiveCases.cql       # CQL: 高血壓活動個案
└── InfluenzaVaccinationCoverage.cql  # CQL: 流感疫苗涵蓋率
```

## 📋 CQL 測量指標

系統支援 3 個 CQL 測量庫：

### 1. COVID-19 疫苗接種涵蓋率 (`COVID19VaccinationCoverage.cql`)
- **指標代碼**: 
  - C19_COV_1PLUS: 至少一劑涵蓋率
  - C19_COV_PRIMARY: 基礎劑量完成率（≥2 劑）
  - C19_COV_BOOSTER: 加強劑涵蓋率（≥3 劑）
- **目標族群**: 12+、18+、65+ 歲、全人口
- **資料來源**: Immunization, Patient

### 2. 高血壓活動個案 (`HypertensionActiveCases.cql`)
- **指標代碼**: 
  - HTN_ACTIVE_COUNT: 高血壓活動個案數
  - HTN_PREV_ADULT: 成人高血壓盛行率（≥20 歲）
  - HTN_PREV_65P: ≥65 歲高血壓盛行率
  - HTN_NEW_CASES: 新發高血壓個案數
- **診斷基準**: WHO 標準（≥140/90 mmHg）或醫師診斷
- **資料來源**: Condition, Observation, Patient

### 3. 流感疫苗接種涵蓋率 (`InfluenzaVaccinationCoverage.cql`)
- **指標代碼**: 
  - FLU_COV_65P: ≥65 歲流感疫苗涵蓋率
  - FLU_COV_RISK: 高風險族群涵蓋率
- **目標族群**: 65+ 歲、高風險族群、全人口
- **資料來源**: Immunization, Patient, Condition

## 🔍 資料過濾條件（由 VS Code 程式管控）

系統支援以下過濾條件：

1. **時間範圍**: 過去 2 年內資料
2. **總人數**: 計算目標族群總數
3. **年齡分組**: 
   - 0-17 歲
   - 18-39 歲
   - 40-64 歲
   - 65 歲以上
4. **性別**: 男性、女性、其他
5. **疫苗類型**: COVID-19、流感等各類疫苗
6. **病患居住地**: 依城市/州別統計

## 🌐 連接的 FHIR 伺服器

1. **SMART Server 1**
   - URL: https://launch.smarthealthit.org/v/r4/fhir
   - 說明: SMART Health IT R4 測試伺服器
   - FHIR 版本: 4.0.0

2. **SMART Server 2**
   - URL: https://r4.smarthealthit.org
   - 說明: SMART Health IT R4 正式伺服器
   - FHIR 版本: 4.0.0

## 📖 國際標準支援

- **HL7 FHIR R4**: 資源結構標準
- **WHO 疫苗涵蓋率指標**: COVID-19 和流感疫苗
- **ECDC/CDC 疫苗接種指南**: 疫苗劑數定義
- **eCQM CMS165**: 高血壓控制測量標準

## 💡 使用提示

1. **首次執行**: 直接執行 `.\test.ps1` 即可，不需要安裝 Python
2. **查看資料**: 產生的 JSON 檔案包含完整的 FHIR 資源
3. **查看報告**: TXT 報告提供易讀的統計摘要
4. **修改設定**: 編輯 `config.json` 可修改伺服器或時間範圍

## 🎯 CQL 運作方式

本系統採用新的運作方式：

1. **CQL 範圍開很大**: CQL 定義廣泛擷取 FHIR 資料
2. **VS Code 程式管控**: 由 Python/PowerShell 程式碼進行細緻的過濾與統計
3. **靈活的顯示條件**: 可依需求調整時間、年齡、性別、地區等條件

## ✨ 成功案例

本次測試成功：
- ✅ 連接 2 個外部 SMART FHIR 伺服器
- ✅ 擷取 100 筆病人資料
- ✅ 擷取 100 筆疫苗接種紀錄
- ✅ 擷取 100 筆診斷紀錄
- ✅ 擷取 100 筆觀察值紀錄
- ✅ 產生統計分析報告
- ✅ 儲存 JSON 和 TXT 報告

## 📞 需要協助？

如有任何問題，請檢查：
1. 網路連線是否正常
2. FHIR 伺服器 URL 是否正確
3. 產生的錯誤訊息

---

**測試日期**: 2025-11-15  
**系統版本**: 1.0.0  
**狀態**: ✅ 正常運作
