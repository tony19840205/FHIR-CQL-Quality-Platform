# 問題解答報告

生成時間：2025-11-16

## 問題 1: COVID-19 疫苗 - 其他伺服器搜尋

### 測試結果

已測試以下公開 FHIR R4 伺服器：

| 伺服器 | URL | 疫苗資料 | COVID-19疫苗 |
|--------|-----|----------|--------------|
| SMART Server 1 | https://launch.smarthealthit.org/v/r4/fhir | ✓ 有 | ✗ 無 |
| SMART Server 2 | https://r4.smarthealthit.org | ✓ 有 | ✗ 無 |
| HAPI FHIR Public | https://hapi.fhir.org/baseR4 | ✓ 有 | ✗ 無 |
| Firely Server | https://server.fire.ly | ✓ 有 | ✗ 無 |

### 搜尋方法

1. **文字搜尋**：搜尋疫苗名稱包含 "COVID", "SARS-CoV-2", "Pfizer", "Moderna", "BioNTech" 等關鍵字
2. **代碼搜尋**：使用 SNOMED (840539006等) 和 CVX (207-213) 疫苗代碼

### 結論

**所有測試的公開 FHIR 伺服器都沒有 COVID-19 疫苗資料**

**原因分析：**
- COVID-19 疫苗於 2020 年底才開始施打
- 公開測試用 FHIR 伺服器使用的是較舊的合成測試資料
- 測試資料庫尚未更新包含 COVID-19 疫苗紀錄

### 建議方案

#### 方案 A：使用現有流感疫苗資料（推薦）✅
- **優點**：
  - 現有資料充足：2,538 筆流感疫苗紀錄（佔 63.4%）
  - 資料分布良好：涵蓋 1946-2021 年
  - CQL 邏輯相同，只需修改疫苗類型篩選條件
  
- **實施步驟**：
  1. 將 `COVID19VaccinationCoverage.cql` 中的疫苗代碼/名稱改為流感疫苗
  2. 測試覆蓋率計算邏輯
  3. 驗證年齡分組、性別分布等功能

#### 方案 B：尋找內部 FHIR 伺服器
- 如果您的機構有內部 FHIR 伺服器並包含 COVID-19 疫苗資料
- 可在 `config.json` 中新增伺服器配置

#### 方案 C：使用其他公開資料源
- 某些國家/地區的公共衛生機構可能提供 COVID-19 FHIR 端點
- 需要進一步調查和認證

---

## 問題 2: 高血壓確診 - 重複計數分析

### 分析結果

**確實存在重複計數問題！**

```
總診斷紀錄數：132 筆
唯一病人數：66 人
重複率：100% (每位病人都有2筆診斷)
平均每人：2.0 筆診斷
```

### 重複原因

1. **同一病人的多次就診紀錄**
   - 病人在不同時間點的高血壓診斷
   - 例如：初診 + 複診

2. **FHIR 資料結構**
   - 每次就醫都會創建新的 Condition 資源
   - 通過 `subject.reference` 連結到同一病人

### 重複案例示例

| 病人ID | 診斷次數 |
|--------|----------|
| Patient/d9427379-943a-42c1-b3d0-6b5056a12696 | 2 |
| Patient/38826a3f-8e5c-4846-95c3-7f12a233447d | 2 |
| Patient/4ef9f896-10bc-4479-acd6-1153e7318f14 | 2 |

### 解決方案

已對 `test.ps1` 腳本進行以下修改：

#### 1. 新增病人去重追蹤
```powershell
$conditionPatients = @{}  # 用於追蹤每種診斷的唯一病人

# 記錄病人ID (用於去重)
$patientRef = if ($c.subject -and $c.subject.reference) { 
    $c.subject.reference 
} else { "未知" }

if (-not $conditionPatients.ContainsKey($name)) {
    $conditionPatients[$name] = @()
}
if ($conditionPatients[$name] -notcontains $patientRef) {
    $conditionPatients[$name] += $patientRef
}
```

#### 2. 報告顯示改進
```powershell
# 原本輸出
高血壓: 132 筆 (3.3%)

# 改進後輸出
高血壓: 132 筆 (3.3%) [去重: 66 人]
```

### CQL 實施建議

在 `HypertensionActiveCases.cql` 中應該：

1. **使用去重邏輯**
   ```cql
   define "Hypertension Patients":
     [Condition: "Hypertension"] C
       where C.clinicalStatus ~ "active"
       return distinct C.subject
   ```

2. **計算唯一病人數**
   ```cql
   define "Active Hypertension Patient Count":
     Count(distinct "Hypertension Patients")
   ```

3. **避免計算診斷次數**
   - 不應該使用 `Count([Condition: "Hypertension"])`
   - 應該使用 `Count(distinct [Condition: "Hypertension"].subject)`

### 驗證結果

下次執行 `test.ps1` 將正確顯示：
- ✓ 總診斷紀錄數：132 筆
- ✓ 唯一病人數：66 人（去重後）
- ✓ 可用於正確計算高血壓患病率

---

## 附加說明

### 修改的文件清單

1. **config.json**
   - 新增 `enabled` 欄位控制伺服器啟用狀態
   - 新增 HAPI FHIR 和 Firely 伺服器選項
   - 使用 UTF-8 編碼避免中文亂碼

2. **test.ps1**
   - 新增伺服器篩選邏輯（只連線 enabled=true 的伺服器）
   - 新增診斷病人去重追蹤
   - 改進報告顯示格式（顯示去重人數）

3. **test_covid19.ps1**（新建）
   - 專門用於搜尋 COVID-19 疫苗的工具腳本
   - 測試多個公開 FHIR 伺服器
   - 使用多種搜尋方法（文字、SNOMED、CVX代碼）

### 執行指令

```powershell
# 執行主要測試（已包含去重功能）
.\test.ps1

# 搜尋 COVID-19 疫苗（如需要）
.\test_covid19.ps1

# 分析現有高血壓資料
$data = Get-Content -Path ".\fhir_data_20251116_000830.json" -Raw | ConvertFrom-Json
$hypertensionConditions = $data.conditions | Where-Object { 
    $_.resource.code.text -like "*Hypertension*" 
}
$uniquePatients = ($hypertensionConditions | ForEach-Object { 
    $_.resource.subject.reference 
} | Select-Object -Unique).Count
Write-Host "高血壓唯一病人數: $uniquePatients"
```

---

## 總結

| 問題 | 狀態 | 解決方案 |
|------|------|----------|
| COVID-19 疫苗資料 | ❌ 未找到 | ✅ 使用流感疫苗替代測試 |
| 高血壓重複計數 | ✅ 已確認 | ✅ 已修改腳本，加入去重功能 |

**下一步建議：**
1. 執行改進後的 `test.ps1` 驗證去重功能
2. 使用流感疫苗資料測試 CQL 覆蓋率邏輯
3. 在 CQL 中實施正確的去重查詢
4. 根據去重後的資料計算準確的統計指標
