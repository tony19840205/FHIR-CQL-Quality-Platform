<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚³æŸ“ç—…æ•¸æ“šæª¢è¦–å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            background: #f8fafc;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        .stat-card h3 {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
        }
        .section {
            padding: 2rem;
        }
        .section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #1e293b;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .disease-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .disease-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #cbd5e1;
        }
        .disease-card h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #334155;
        }
        .disease-card .disease-stats {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .disease-card .disease-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
        }
        .disease-card .disease-stat .label {
            color: #64748b;
        }
        .disease-card .disease-stat .value {
            font-weight: 600;
            color: #1e293b;
        }
        .sample-patients {
            margin-top: 1rem;
        }
        .patient-card {
            background: white;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        .patient-card .patient-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .patient-card .patient-details {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.5;
        }
        .loading {
            text-align: center;
            padding: 4rem;
            font-size: 1.2rem;
            color: #64748b;
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            border-left: 4px solid #c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦  å‚³æŸ“ç—…ç›£æ¸¬æ•¸æ“šæª¢è¦–å™¨</h1>
            <p>æœ¬åœ°ç”Ÿæˆæ•¸æ“šé©—è­‰å·¥å…·</p>
        </div>

        <div id="loading" class="loading">
            <p>ğŸ“Š æ­£åœ¨è¼‰å…¥æ•¸æ“š...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- ç¸½è¦½çµ±è¨ˆ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ç¸½ç—…äººæ•¸</h3>
                    <div class="value" id="totalPatients">0</div>
                </div>
                <div class="stat-card">
                    <h3>å°±è¨ºè¨˜éŒ„</h3>
                    <div class="value" id="totalEncounters">0</div>
                </div>
                <div class="stat-card">
                    <h3>è¨ºæ–·è¨˜éŒ„</h3>
                    <div class="value" id="totalConditions">0</div>
                </div>
                <div class="stat-card">
                    <h3>è§€å¯Ÿè¨˜éŒ„</h3>
                    <div class="value" id="totalObservations">0</div>
                </div>
                <div class="stat-card">
                    <h3>ç–«è‹—æ¥ç¨®</h3>
                    <div class="value" id="totalImmunizations">0</div>
                </div>
                <div class="stat-card">
                    <h3>ç¸½è³‡æºæ•¸</h3>
                    <div class="value" id="totalResources">0</div>
                </div>
            </div>

            <!-- ç–¾ç—…åˆ†é¡çµ±è¨ˆ -->
            <div class="section">
                <h2>ğŸ“‹ ç–¾ç—…åˆ†é¡çµ±è¨ˆ</h2>
                <div class="disease-breakdown" id="diseaseBreakdown"></div>
            </div>

            <!-- æ¨£æœ¬ç—…äºº -->
            <div class="section">
                <h2>ğŸ‘¥ æ¨£æœ¬ç—…äººè³‡æ–™ï¼ˆå‰10ç­†ï¼‰</h2>
                <div class="sample-patients" id="samplePatients"></div>
            </div>
        </div>

        <div id="error" style="display: none;" class="error"></div>
    </div>

    <script>
        async function loadData() {
            try {
                // è¼‰å…¥ Bundle æ•¸æ“š
                const response = await fetch('infectious_disease_bundle.json');
                if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥æ•¸æ“šæª”æ¡ˆ');
                
                const bundle = await response.json();
                console.log('Bundle loaded:', bundle);
                
                // è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                const statsResponse = await fetch('infectious_disease_stats.json');
                if (!statsResponse.ok) throw new Error('ç„¡æ³•è¼‰å…¥çµ±è¨ˆæª”æ¡ˆ');
                
                const stats = await statsResponse.json();
                console.log('Stats loaded:', stats);
                
                // åˆ†ææ•¸æ“š
                analyzeData(bundle, stats);
                
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'âŒ éŒ¯èª¤: ' + error.message + '\n' + error.stack;
            }
        }

        function analyzeData(bundle, stats) {
            // çµ±è¨ˆå„é¡å‹è³‡æº
            const resourceTypes = {};
            const patients = [];
            const conditions = [];
            
            bundle.entry.forEach(entry => {
                const resource = entry.resource;
                const type = resource.resourceType;
                
                resourceTypes[type] = (resourceTypes[type] || 0) + 1;
                
                if (type === 'Patient') {
                    patients.push(resource);
                } else if (type === 'Condition') {
                    conditions.push(resource);
                }
            });

            // æ›´æ–°çµ±è¨ˆå¡ç‰‡
            document.getElementById('totalPatients').textContent = resourceTypes['Patient'] || 0;
            document.getElementById('totalEncounters').textContent = resourceTypes['Encounter'] || 0;
            document.getElementById('totalConditions').textContent = resourceTypes['Condition'] || 0;
            document.getElementById('totalObservations').textContent = resourceTypes['Observation'] || 0;
            document.getElementById('totalImmunizations').textContent = resourceTypes['Immunization'] || 0;
            document.getElementById('totalResources').textContent = bundle.entry.length;

            // ç–¾ç—…åˆ†é¡çµ±è¨ˆ
            const diseaseStats = stats.disease_distribution;
            displayDiseaseBreakdown(diseaseStats);

            // é¡¯ç¤ºæ¨£æœ¬ç—…äºº
            displaySamplePatients(patients, conditions);

            // é¡¯ç¤ºå…§å®¹
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        function displayDiseaseBreakdown(diseaseStats) {
            const container = document.getElementById('diseaseBreakdown');
            
            if (!diseaseStats || typeof diseaseStats !== 'object') {
                console.error('Invalid diseaseStats:', diseaseStats);
                container.innerHTML = '<p style="color: red;">çµ±è¨ˆæ•¸æ“šæ ¼å¼éŒ¯èª¤</p>';
                return;
            }
            
            const diseaseNames = {
                'covid19': 'ğŸ¦  COVID-19',
                'influenza': 'ğŸ¤§ æµæ„Ÿ',
                'conjunctivitis': 'ğŸ‘ï¸ æ€¥æ€§çµè†œç‚',
                'enterovirus': 'âœ‹ è…¸ç—…æ¯’',
                'diarrhea': 'ğŸ¦  æ€¥æ€§è…¹ç€‰'
            };

            for (const [disease, data] of Object.entries(diseaseStats)) {
                const card = document.createElement('div');
                card.className = 'disease-card';
                
                const severityHTML = Object.entries(data.severity)
                    .map(([severity, count]) => `
                        <div class="disease-stat">
                            <span class="label">${severity}</span>
                            <span class="value">${count} ä¾‹</span>
                        </div>
                    `).join('');

                card.innerHTML = `
                    <h3>${diseaseNames[disease] || disease}</h3>
                    <div class="disease-stats">
                        <div class="disease-stat">
                            <span class="label">ç¸½ç—…ä¾‹æ•¸</span>
                            <span class="value">${data.total}</span>
                        </div>
                        ${severityHTML}
                    </div>
                `;
                
                container.appendChild(card);
            }
        }

        function displaySamplePatients(patients, conditions) {
            const container = document.getElementById('samplePatients');
            const sampleSize = Math.min(10, patients.length);
            
            for (let i = 0; i < sampleSize; i++) {
                const patient = patients[i];
                const patientConditions = conditions.filter(c => 
                    c.subject.reference === `Patient/${patient.id}`
                );

                const card = document.createElement('div');
                card.className = 'patient-card';
                
                const conditionList = patientConditions.map(c => {
                    const code = c.code.coding[0];
                    return `${code.code} - ${code.display}`;
                }).join('<br>');

                card.innerHTML = `
                    <div class="patient-header">
                        <span>${patient.name[0].text}</span>
                        <span>${patient.gender === 'male' ? 'ç”·' : 'å¥³'} | ${patient.birthDate}</span>
                    </div>
                    <div class="patient-details">
                        <strong>ID:</strong> ${patient.id}<br>
                        <strong>åœ°å€:</strong> ${patient.address[0].city}<br>
                        <strong>è¨ºæ–·:</strong><br>${conditionList || 'ç„¡è¨ºæ–·è¨˜éŒ„'}
                    </div>
                `;
                
                container.appendChild(card);
            }
        }

        // è¼‰å…¥æ•¸æ“š
        loadData();
    </script>
</body>
</html>
