<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‰éˆ•æ¸¬è©¦è¨ºæ–·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #3b82f6;
            color: white;
        }
        button:hover {
            background: #2563eb;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
        }
        .error {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }
        .success {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
        }
    </style>
</head>
<body>
    <h1>ğŸ” FHIR Dashboard æŒ‰éˆ•åŠŸèƒ½è¨ºæ–·</h1>

    <div class="test-section">
        <h2>1. JavaScript è¼‰å…¥æª¢æ¸¬</h2>
        <button onclick="testJavaScriptLoad()">æª¢æ¸¬ JS æª”æ¡ˆ</button>
        <div id="jsLoadResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>2. FHIR é€£ç·šç‹€æ…‹</h2>
        <button onclick="testFHIRConnection()">æª¢æ¸¬ FHIR é€£ç·š</button>
        <div id="fhirConnResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>3. localStorage è¨­å®š</h2>
        <button onclick="testLocalStorage()">æª¢æ¸¬ localStorage</button>
        <div id="localStorageResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>4. æŒ‰éˆ•é»æ“Šæ¸¬è©¦</h2>
        <button onclick="testButtonClick()">æ¸¬è©¦æŒ‰éˆ•é»æ“Š</button>
        <button onclick="testExecuteQuery()">æ¸¬è©¦ executeQuery å‡½æ•¸</button>
        <div id="buttonTestResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>5. FHIR æŸ¥è©¢æ¸¬è©¦</h2>
        <button onclick="testFHIRQuery()">æ¸¬è©¦ FHIR æŸ¥è©¢</button>
        <div id="fhirQueryResult" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>6. å¿«é€Ÿä¿®å¾©</h2>
        <button onclick="setTestServer()">è¨­å®šæ¸¬è©¦ä¼ºæœå™¨</button>
        <button onclick="clearAllSettings()">æ¸…é™¤æ‰€æœ‰è¨­å®š</button>
        <div id="fixResult" class="result" style="display:none;"></div>
    </div>

    <!-- è¼‰å…¥ Dashboard çš„ JavaScript -->
    <script src="js/fhir-connection.js"></script>
    <script src="js/quality-indicators.js"></script>

    <script>
        function showResult(elementId, message, type = 'result') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.innerHTML = message;
        }

        function testJavaScriptLoad() {
            let results = [];
            
            // æª¢æ¸¬ FHIRConnection
            if (typeof FHIRConnection !== 'undefined') {
                results.push('âœ… fhir-connection.js å·²è¼‰å…¥');
            } else {
                results.push('âŒ fhir-connection.js æœªè¼‰å…¥');
            }
            
            // æª¢æ¸¬ executeQuery
            if (typeof executeQuery === 'function') {
                results.push('âœ… executeQuery å‡½æ•¸å­˜åœ¨');
            } else {
                results.push('âŒ executeQuery å‡½æ•¸ä¸å­˜åœ¨');
            }
            
            // æª¢æ¸¬ refreshData
            if (typeof refreshData === 'function') {
                results.push('âœ… refreshData å‡½æ•¸å­˜åœ¨');
            } else {
                results.push('âŒ refreshData å‡½æ•¸ä¸å­˜åœ¨');
            }
            
            // æª¢æ¸¬ executeAllMedication
            if (typeof executeAllMedication === 'function') {
                results.push('âœ… executeAllMedication å‡½æ•¸å­˜åœ¨');
            } else {
                results.push('âŒ executeAllMedication å‡½æ•¸ä¸å­˜åœ¨');
            }
            
            const hasErrors = results.some(r => r.startsWith('âŒ'));
            showResult('jsLoadResult', results.join('<br>'), hasErrors ? 'error' : 'success');
        }

        function testFHIRConnection() {
            let results = [];
            
            if (window.fhirConnection) {
                results.push('âœ… window.fhirConnection å­˜åœ¨');
                results.push(`ğŸ“ ä¼ºæœå™¨: ${window.fhirConnection.serverUrl || 'æœªè¨­å®š'}`);
                results.push(`ğŸ”‘ Token: ${window.fhirConnection.authToken ? 'å·²è¨­å®š' : 'æœªè¨­å®š'}`);
                results.push(`ğŸ”Œ é€£ç·šç‹€æ…‹: ${window.fhirConnection.isConnected ? 'å·²é€£ç·š' : 'æœªé€£ç·š'}`);
            } else {
                results.push('âŒ window.fhirConnection ä¸å­˜åœ¨');
            }
            
            const hasErrors = results.some(r => r.startsWith('âŒ'));
            showResult('fhirConnResult', results.join('<br>'), hasErrors ? 'error' : 'result');
        }

        function testLocalStorage() {
            let results = [];
            
            const fhirServer = localStorage.getItem('fhirServer');
            const authToken = localStorage.getItem('authToken');
            const demoMode = localStorage.getItem('demoMode');
            
            results.push(`ğŸ“ FHIR ä¼ºæœå™¨: ${fhirServer || 'æœªè¨­å®š'}`);
            results.push(`ğŸ”‘ Auth Token: ${authToken ? 'å·²è¨­å®š' : 'æœªè¨­å®š'}`);
            results.push(`ğŸ­ ç¤ºç¯„æ¨¡å¼: ${demoMode || 'æœªè¨­å®š'}`);
            
            if (!fhirServer) {
                results.push('<br>âš ï¸ <strong>æœªè¨­å®š FHIR ä¼ºæœå™¨,é€™å¯èƒ½æ˜¯æŒ‰éˆ•ç„¡æ³•ä½œç”¨çš„åŸå› !</strong>');
            }
            
            showResult('localStorageResult', results.join('<br>'), !fhirServer ? 'error' : 'result');
        }

        function testButtonClick() {
            const result = 'âœ… æŒ‰éˆ•é»æ“Šäº‹ä»¶æ­£å¸¸!<br>å¦‚æœæ‚¨çœ‹åˆ°é€™å€‹è¨Šæ¯,è¡¨ç¤ºæŒ‰éˆ•çš„ onclick äº‹ä»¶å¯ä»¥æ­£å¸¸åŸ·è¡Œã€‚';
            showResult('buttonTestResult', result, 'success');
        }

        async function testExecuteQuery() {
            try {
                showResult('buttonTestResult', 'â³ æ¸¬è©¦ä¸­...', 'result');
                
                if (typeof executeQuery !== 'function') {
                    showResult('buttonTestResult', 'âŒ executeQuery å‡½æ•¸ä¸å­˜åœ¨!', 'error');
                    return;
                }
                
                // æª¢æŸ¥ FHIR é€£ç·š
                if (!window.fhirConnection || !window.fhirConnection.serverUrl) {
                    showResult('buttonTestResult', 
                        'âŒ FHIR é€£ç·šæœªè¨­å®š!<br><br>è«‹é»æ“Šä¸‹æ–¹ã€Œè¨­å®šæ¸¬è©¦ä¼ºæœå™¨ã€æŒ‰éˆ•ä¾†å»ºç«‹é€£ç·šã€‚', 
                        'error');
                    return;
                }
                
                showResult('buttonTestResult', 
                    'âœ… executeQuery å‡½æ•¸å¯ä»¥å‘¼å«<br>ğŸ“ FHIR ä¼ºæœå™¨: ' + window.fhirConnection.serverUrl, 
                    'success');
                
            } catch (error) {
                showResult('buttonTestResult', `âŒ éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testFHIRQuery() {
            try {
                showResult('fhirQueryResult', 'â³ æŸ¥è©¢ä¸­...', 'result');
                
                if (!window.fhirConnection || !window.fhirConnection.serverUrl) {
                    showResult('fhirQueryResult', 'âŒ è«‹å…ˆè¨­å®š FHIR é€£ç·š!', 'error');
                    return;
                }
                
                const url = window.fhirConnection.serverUrl;
                
                // æ¸¬è©¦åŸºæœ¬æŸ¥è©¢
                const response = await fetch(`${url}/Patient?_count=1`);
                const data = await response.json();
                
                if (data.resourceType === 'Bundle') {
                    const count = data.entry?.length || 0;
                    showResult('fhirQueryResult', 
                        `âœ… FHIR æŸ¥è©¢æˆåŠŸ!<br>ğŸ“Š æ‰¾åˆ° ${data.total || count} ç­† Patient è³‡æ–™`, 
                        'success');
                } else {
                    showResult('fhirQueryResult', `âš ï¸ å›æ‡‰æ ¼å¼: ${JSON.stringify(data).substring(0, 200)}`, 'result');
                }
                
            } catch (error) {
                showResult('fhirQueryResult', `âŒ æŸ¥è©¢å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function setTestServer() {
            const testServer = 'https://emr-smart.appx.com.tw/v/r4/fhir';
            
            // å„²å­˜åˆ° localStorage
            localStorage.setItem('fhirServer', testServer);
            localStorage.removeItem('authToken');
            
            // å»ºç«‹é€£ç·š
            if (typeof FHIRConnection !== 'undefined') {
                window.fhirConnection = new FHIRConnection();
                window.fhirConnection.serverUrl = testServer;
                window.fhirConnection.authToken = '';
                window.fhirConnection.isConnected = true;
            }
            
            showResult('fixResult', 
                `âœ… å·²è¨­å®šæ¸¬è©¦ä¼ºæœå™¨<br>ğŸ“ ${testServer}<br><br>ç¾åœ¨å¯ä»¥è¿”å› quality-indicators.html æ¸¬è©¦æŒ‰éˆ•åŠŸèƒ½!`, 
                'success');
        }

        function clearAllSettings() {
            localStorage.clear();
            if (window.fhirConnection) {
                window.fhirConnection = null;
            }
            showResult('fixResult', 'âœ… å·²æ¸…é™¤æ‰€æœ‰è¨­å®š', 'success');
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œè¨ºæ–·
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ” è¨ºæ–·é é¢å·²è¼‰å…¥');
            
            // è‡ªå‹•åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
            setTimeout(() => {
                testJavaScriptLoad();
                testFHIRConnection();
                testLocalStorage();
            }, 500);
        });
    </script>
</body>
</html>
