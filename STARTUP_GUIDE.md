# 🚀 FHIR Dashboard 外部服務啟動指南

## 📋 系統概述

本系統採用四節點架構，實現醫療數據的安全分層訪問：

```
FHIR 伺服器 → 控制網頁 → 民眾網頁 → LLM 智能模型
```

### 架構說明：
- **FHIR 伺服器**：儲存完整病患資料
- **控制網頁**：醫護人員使用，可查詢完整資料
- **民眾網頁**：公開版，僅顯示匿名統計數據
- **LLM 智能模型**：提供 AI 健康分析

## 🎯 功能特色

### 1. 動態連接狀態視覺化
- ✅ 四節點連接圖，即時顯示資料流向
- ✅ 連接線動畫：已連接（綠色）、斷開（紅叉）、傳輸中（流動效果）
- ✅ 資料粒子動畫，視覺化數據傳輸過程

### 2. 智能狀態切換
**正常模式：**
```
FHIR ↔ 控制網頁（綠色連線）
控制網頁 ✗ 民眾網頁（斷開）
民眾網頁 ✗ LLM（斷開）
```

**外部服務模式：**
```
FHIR ✗ 控制網頁（斷開）
控制網頁 ✗ 民眾網頁（資料已傳輸完成）
民眾網頁 ↔ LLM（綠色連線，AI 分析中）
```

### 3. 資料安全保護
- 🔒 自動去識別化處理
- 🔒 僅傳輸統計數字，無病患個資
- 🔒 控制網頁與民眾網頁分離運行

## 📖 使用指南

### 方式一：從首頁啟動（推薦）

1. **開啟首頁**
   ```
   http://localhost/index.html
   ```

2. **找到「系統連接狀態」區塊**
   - 可以看到四個節點的連接圖
   - 預設狀態：FHIR ↔ 控制網頁

3. **點擊「啟動外部 UI & LLM 服務」按鈕**
   
   系統將自動執行以下動畫序列：
   
   **階段 1（1秒）：斷開 FHIR**
   - 控制網頁與 FHIR 斷開連接
   - 提示：「正在切換至外部服務模式...」
   
   **階段 2（2.5秒）：資料傳輸**
   - 控制網頁 → 民眾網頁之間出現流動動畫
   - 資料粒子從左往右移動
   - 提示：「正在傳輸統計資料到民眾版...」
   
   **階段 3（1秒）：建立 LLM 連接**
   - 民眾網頁 ↔ LLM 建立綠色連線
   - 提示：「✅ 民眾版已上線，AI 分析已啟用」
   - 自動開啟民眾版視窗

4. **民眾版視窗自動開啟**
   - 顯示匿名統計數據
   - AI 自動開始分析（如果後端已啟動）

5. **關閉外部服務**
   - 點擊按鈕上的「點擊關閉」
   - 系統執行反向動畫，回到正常模式

### 方式二：直接訪問民眾版

如果只想查看民眾版（不需要動畫）：

```
http://localhost/public/public-view.html
```

注意：需要先從控制網頁推送過資料，否則顯示「等待資料更新...」

## 🖥️ 後端設置（可選）

如果想啟用真實的 AI 分析功能：

### 1. 安裝 Node.js
確保已安裝 Node.js（v14 或更高版本）

### 2. 安裝依賴
```bash
cd backend
npm install
```

### 3. 設定 OpenAI API Key
```bash
# 複製環境變數範例
cp .env.example .env

# 編輯 .env 檔案
# 填入你的 OpenAI API Key
OPENAI_API_KEY=sk-your-key-here
```

### 4. 啟動後端伺服器
```bash
# 開發模式（推薦）
npm run dev

# 或生產模式
npm start
```

伺服器將在 `http://localhost:3000` 運行

### 5. 驗證後端
訪問：`http://localhost:3000/api/health`

應該看到：
```json
{
  "status": "ok",
  "timestamp": "...",
  "usage": { ... }
}
```

## 🎨 UI 元素說明

### 連接狀態指示器
- **綠色線 + 箭頭**：已連接，資料可流通
- **紅色 ✗**：已斷開
- **流動漸變 + 粒子**：資料傳輸中

### 節點圖示
- 🗄️ **FHIR**：藍色，資料庫圖示
- 🖥️ **控制網頁**：綠色，桌面圖示
- 👥 **民眾網頁**：紫色，用戶群組圖示
- 🧠 **LLM**：紅色，大腦圖示

### 按鈕狀態
- **灰綠色「啟動外部 UI & LLM 服務」**：未啟動
- **黃色「正在啟動服務...」 + 旋轉圖示**：啟動中
- **紅色「外部服務運行中 · 點擊關閉」**：已啟動

## 📊 資料流程

### 完整流程圖

```
1. 醫護人員在控制網頁執行 CQL 查詢
   ↓
2. 從 FHIR 伺服器獲取完整病患資料
   ↓
3. 點擊「啟動外部服務」按鈕
   ↓
4. 系統自動提取統計數據：
   - 病例總數
   - 疾病類型分佈
   - 疫苗接種率
   - 慢性病管理統計
   - ESG 指標
   - 醫療品質指標
   ↓
5. 去識別化處理（移除所有個資）
   ↓
6. 推送到 localStorage
   ↓
7. 民眾版網頁讀取統計數據
   ↓
8. 發送統計數據到 LLM 後端
   ↓
9. LLM 生成健康趨勢分析
   ↓
10. 顯示在民眾版頁面
```

### 資料去識別化

**原始資料（控制網頁）：**
```json
{
  "patientId": "P001",
  "name": "王大明",
  "age": 45,
  "diagnosis": "高血壓",
  "medication": "降血壓藥"
}
```

**去識別化後（民眾網頁）：**
```json
{
  "disease": {
    "hypertension": 1234,
    "diabetes": 567,
    "controlRate": 78
  }
}
```

## ⚙️ 技術架構

### 前端
- **HTML5 + CSS3 + Vanilla JavaScript**
- **localStorage** 用於跨頁面資料傳遞
- **CSS 動畫** 實現流暢的視覺效果

### 後端（可選）
- **Node.js + Express**
- **OpenAI API** 提供 LLM 分析
- **CORS** 允許跨域請求

### 資料流
- **控制網頁 → localStorage → 民眾網頁**
- **民眾網頁 → HTTP API → LLM 後端**

## 🔧 疑難排解

### 問題 1：按鈕點擊無反應
**解決：**
1. 打開瀏覽器 Console（F12）
2. 檢查是否有 JavaScript 錯誤
3. 確認 `connection-manager.js` 已載入

### 問題 2：民眾版顯示「等待資料更新」
**解決：**
1. 先回到控制網頁（任一儀表板）
2. 執行一次 CQL 查詢
3. 點擊「啟動外部服務」按鈕
4. 系統會自動推送資料並開啟民眾版

### 問題 3：AI 分析顯示「等待 AI 分析啟動」
**解決方式 A（使用示範模式）：**
- 民眾版會自動顯示預設的示範分析
- 無需後端伺服器

**解決方式 B（啟用真實 LLM）：**
1. 確認後端伺服器已啟動（`npm run dev`）
2. 檢查 `http://localhost:3000/api/health`
3. 確認 OpenAI API Key 已設定

### 問題 4：動畫不流暢
**解決：**
- 使用現代瀏覽器（Chrome、Edge、Firefox 最新版）
- 關閉瀏覽器的硬體加速（如果出現問題）
- 檢查 CPU 使用率

### 問題 5：民眾版視窗被阻擋
**解決：**
- 瀏覽器可能阻擋彈出視窗
- 允許來自該網站的彈出視窗
- 或手動訪問 `public/public-view.html`

## 📈 最佳實踐

### 1. 資料更新頻率
- 建議：每次執行新的 CQL 查詢後，重新推送資料
- 民眾版每 5 秒自動檢查更新

### 2. 後端成本控制
- GPT-3.5-turbo：每次分析 ~$0.001
- 建議設置每日配額
- 監控 `/api/usage` 端點

### 3. 安全建議
- 控制網頁應有存取控制
- 民眾版可公開訪問（無敏感資料）
- 後端 API 建議添加身份驗證

## 🎓 進階功能

### 自訂統計提取
編輯 `js/statistics-pusher.js`，修改：
- `extractDiseaseStatistics()`
- `extractChronicStatistics()`
- `extractESGStatistics()`
- `extractQualityStatistics()`

### 自訂 AI 提示詞
編輯 `public/public-view.js`，修改：
- `generateAIPrompt()` 函數

### 自訂動畫時長
編輯 `js/connection-manager.js`，修改 `sleep()` 的毫秒數：
- 階段 1：`await this.sleep(1000)` → 調整斷開時間
- 階段 2：`await this.sleep(2500)` → 調整傳輸動畫時間
- 階段 3：`await this.sleep(1000)` → 調整連接時間

## 📞 支援

如有問題，請檢查：
1. 瀏覽器 Console 日誌
2. 後端伺服器日誌（如果啟動）
3. localStorage 內容（開發者工具 → Application → Local Storage）

---

✨ **享受使用您的智能醫療資訊平台！**
